<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":210,"display":"post","padding":18,"offset":8,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="第二章 JDBC必知必会1、配置单个数据源建立h2、web、lombak的springboot。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354package com.example.learn;import com.example.learn.c">
<meta property="og:type" content="article">
<meta property="og:title" content="玩转Spring全家桶学习笔记">
<meta property="og:url" content="http://example.com/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="JQ的技术博客">
<meta property="og:description" content="第二章 JDBC必知必会1、配置单个数据源建立h2、web、lombak的springboot。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354package com.example.learn;import com.example.learn.c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/04/17/images/8d1542c72a220d01da05ce791304e2803b1fb05f16400305babfafdf9b0289bb.png">
<meta property="og:image" content="http://example.com/2022/04/17/images/fe7f6ebc510e9a192a19749197febf38cb9950cebdeae177e6a9c8daf9d89287.png">
<meta property="og:image" content="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/images/mvc-contexts.gif">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/6296056/ih4rv8o45f.png?imageView2/2/w/1620">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/6296056/h8202u7yaw.png?imageView2/2/w/1620">
<meta property="og:image" content="http://example.com/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/WX20220511-094520.png">
<meta property="og:image" content="http://example.com/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/WX20220511-094749.png">
<meta property="og:image" content="http://example.com/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/WX20220514-112926.png">
<meta property="article:published_time" content="2022-04-17T13:21:32.000Z">
<meta property="article:modified_time" content="2022-08-10T14:06:50.309Z">
<meta property="article:author" content="JQ">
<meta property="article:tag" content="SpringMVC">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/04/17/images/8d1542c72a220d01da05ce791304e2803b1fb05f16400305babfafdf9b0289bb.png">

<link rel="canonical" href="http://example.com/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>玩转Spring全家桶学习笔记 | JQ的技术博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="JQ的技术博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">JQ的技术博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="JQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JQ的技术博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          玩转Spring全家桶学习笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-17 21:21:32" itemprop="dateCreated datePublished" datetime="2022-04-17T21:21:32+08:00">2022-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-10 22:06:50" itemprop="dateModified" datetime="2022-08-10T22:06:50+08:00">2022-08-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-%E5%85%A8%E5%AE%B6%E6%A1%B6%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Spring 全家桶系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>109k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:39</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="第二章-JDBC必知必会"><a href="#第二章-JDBC必知必会" class="headerlink" title="第二章 JDBC必知必会"></a>第二章 JDBC必知必会</h2><h3 id="1、配置单个数据源"><a href="#1、配置单个数据源" class="headerlink" title="1、配置单个数据源"></a>1、配置单个数据源</h3><p>建立h2、web、lombak的springboot。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.learn;</span><br><span class="line"><span class="keyword">import</span> com.example.learn.config.ProfileProperties;</span><br><span class="line"><span class="keyword">import</span> com.example.learn.service.LibraryProperties;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(DemoApplication.class);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(DemoApplication.class, args);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		showConnection();</span><br><span class="line">		showData();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">showData</span><span class="params">()</span> &#123;</span><br><span class="line">		jdbcTemplate.queryForList(<span class="string">&quot;SELECT * FROM FOO&quot;</span>).forEach(row -&gt; log.info(row.toString()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">showConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">		log.info(dataSource.toString());</span><br><span class="line">		<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">		log.info(conn.toString());</span><br><span class="line">		conn.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在resource目录先创建schema.sql文件，写入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> FOO (ID <span class="type">INT</span> <span class="keyword">IDENTITY</span>, BAR <span class="type">VARCHAR</span>(<span class="number">64</span>));</span><br></pre></td></tr></table></figure>

<p>在resource目录先创建data.sql文件，写入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> FOO (ID, BAR) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> FOO (ID, BAR) <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">&#x27;bbb&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h3 id="2、配置多个数据源"><a href="#2、配置多个数据源" class="headerlink" title="2、配置多个数据源"></a>2、配置多个数据源</h3><p>配置文件<code>application.properties</code>中写入数据源的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">foo.datasource.url=jdbc:h2:mem:foo</span><br><span class="line">foo.datasource.username=sa</span><br><span class="line">foo.datasource.password=</span><br><span class="line"></span><br><span class="line">bar.datasource.url=jdbc:h2:mem:bar</span><br><span class="line">bar.datasource.username=sa</span><br><span class="line">bar.datasource.password=</span><br></pre></td></tr></table></figure>

<p>需要指定使用什么连接池：COMMONS-DBCP、TOMCAT-JDBC、HIKARICP。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> multiDatasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 排除自动配置，进行手动配置</span></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">		DataSourceTransactionManagerAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">		JdbcTemplateAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiDataSourceApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(MultiDataSourceApplication.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(MultiDataSourceApplication.class, args);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConfigurationProperties(&quot;foo.datasource&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> DataSourceProperties <span class="title function_">fooDataSourceProperties</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProperties</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">fooDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="type">DataSourceProperties</span> <span class="variable">dataSourceProperties</span> <span class="operator">=</span> fooDataSourceProperties();</span><br><span class="line">		log.info(<span class="string">&quot;foo datasource:&#123;&#125;&quot;</span>, dataSourceProperties.getUrl());</span><br><span class="line">		<span class="keyword">return</span> dataSourceProperties.initializeDataSourceBuilder().build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">public</span> PlatformTransactionManager <span class="title function_">fooTxManager</span><span class="params">(DataSource fooDataSource)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(fooDataSource);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConfigurationProperties(&quot;bar.datasource&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> DataSourceProperties <span class="title function_">barDataSourceProperties</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProperties</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">barDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="type">DataSourceProperties</span> <span class="variable">dataSourceProperties</span> <span class="operator">=</span> barDataSourceProperties();</span><br><span class="line">		log.info(<span class="string">&quot;bar datasource:&#123;&#125;&quot;</span>, dataSourceProperties.getUrl());</span><br><span class="line">		<span class="keyword">return</span> dataSourceProperties.initializeDataSourceBuilder().build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">public</span> PlatformTransactionManager <span class="title function_">barTxManager</span><span class="params">(DataSource barDataSource)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(barDataSource);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、数据库连接池推荐"><a href="#3、数据库连接池推荐" class="headerlink" title="3、数据库连接池推荐"></a>3、数据库连接池推荐</h3><ul>
<li>druid：快</li>
<li>HikariCP：监控、SQL防注入</li>
</ul>
<h3 id="4、JdbcTemplate-的使用"><a href="#4、JdbcTemplate-的使用" class="headerlink" title="4、JdbcTemplate 的使用"></a>4、JdbcTemplate 的使用</h3><p>首先，添加H2数据库的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后,创建和表对应的Entiy。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String bar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，完成数据库的查询，添加等功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> simplejdbcdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.RowMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.simple.SimpleJdbcInsert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooDao</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpleJdbcInsert simpleJdbcInsert;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertData</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="comment">// 方法一：使用jdbcTemplate</span></span><br><span class="line">        Arrays.asList(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>).forEach(bar -&gt; &#123;</span><br><span class="line">            jdbcTemplate.update(<span class="string">&quot;insert into Foo (bar) values (?)&quot;</span>, bar);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//方法二：使用simpleJdbcInsert</span></span><br><span class="line">		HashMap&lt;String, String&gt; row = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        row.put(<span class="string">&quot;bar&quot;</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line">        <span class="type">Number</span> <span class="variable">id</span> <span class="operator">=</span> simpleJdbcInsert.executeAndReturnKey(row);</span><br><span class="line">        log.info(<span class="string">&quot;ID of d: &#123;&#125;&quot;</span>, id.longValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listData</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Count: &#123;&#125;&quot;</span>,jdbcTemplate.queryForObject(<span class="string">&quot;select count(*) from foo&quot;</span>, Long.class));</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; list = jdbcTemplate.queryForList(<span class="string">&quot;select bar from foo&quot;</span>, String.class);</span><br><span class="line">        list.forEach(s -&gt; &#123;log.info(<span class="string">&quot;Bar: &#123;&#125;&quot;</span>, s);&#125;);</span><br><span class="line"></span><br><span class="line">        List&lt;Foo&gt; fooList = jdbcTemplate.query(<span class="string">&quot;select * from foo&quot;</span>, <span class="keyword">new</span> <span class="title class_">RowMapper</span>&lt;Foo&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Foo <span class="title function_">mapRow</span><span class="params">(ResultSet rs, <span class="type">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">                <span class="keyword">return</span> Foo.builder().id(rs.getLong(<span class="number">1</span>)).bar(rs.getString(<span class="number">2</span>)).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        fooList.forEach(f -&gt; log.info(<span class="string">&quot;Foo: &#123;&#125;&quot;</span>, f));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，在程序入口调用数据库操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> simplejdbcdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.simple.SimpleJdbcInsert;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SiampleJdbcDemoApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(SiampleJdbcDemoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	FooDao fooDao;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">public</span> SimpleJdbcInsert <span class="title function_">simpleJdbcInsert</span><span class="params">(JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">		<span class="comment">// 将 FOO 和 ID 绑定。</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleJdbcInsert</span>(jdbcTemplate)</span><br><span class="line">				.withTableName(<span class="string">&quot;FOO&quot;</span>).usingGeneratedKeyColumns(<span class="string">&quot;ID&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		fooDao.insertData();</span><br><span class="line">		fooDao.listData();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、NamedParameterJdbcTemplate"><a href="#5、NamedParameterJdbcTemplate" class="headerlink" title="5、NamedParameterJdbcTemplate"></a>5、NamedParameterJdbcTemplate</h3><h3 id="6、事务"><a href="#6、事务" class="headerlink" title="6、事务"></a>6、事务</h3><ul>
<li>编程式事务</li>
<li>声明式事务（推荐使用）<h4 id="编程式事务"><a href="#编程式事务" class="headerlink" title="编程式事务"></a>编程式事务</h4></li>
<li>TransactionTemplate</li>
<li>PlatformTransactionTemplate  </li>
</ul>
<p>引入H2数据库的依赖。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.TransactionCallbackWithoutResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.TransactionTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionDemoApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(TransactionDemoApplication.class);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JdbcTemplate jdbcTemplate;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	TransactionTemplate transactionTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(TransactionDemoApplication.class, args);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		log.info(<span class="string">&quot;count before transaction: &#123;&#125;&quot;</span>, getCount());</span><br><span class="line"></span><br><span class="line">		transactionTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionCallbackWithoutResult</span>() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doInTransactionWithoutResult</span><span class="params">(TransactionStatus status)</span> &#123;</span><br><span class="line">				jdbcTemplate.execute(<span class="string">&quot;INSERT INTO FOO (ID, BAR) VALUES (1, &#x27;AAA&#x27;)&quot;</span>);</span><br><span class="line">				log.info(<span class="string">&quot;count in transaction: &#123;&#125;&quot;</span>, getCount());</span><br><span class="line">				status.setRollbackOnly();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;count after transaction: &#123;&#125;&quot;</span>, getCount());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getCount</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//		List&lt;Integer&gt; list = jdbcTemplate.queryForList(&quot;select count(*) as cnt from FOO&quot;, Integer.class);</span></span><br><span class="line"><span class="comment">//		log.info(String.valueOf(list.get(0)));</span></span><br><span class="line">		<span class="keyword">return</span> (<span class="type">long</span>)jdbcTemplate.queryForList(<span class="string">&quot;select count(*) as cnt from FOO&quot;</span>).get(<span class="number">0</span>).get(<span class="string">&quot;cnt&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h4><p>在 XML 配置文件中配置或者基于注解，实际是通过 AOP 实现（基于@Transactional 的全注解方式使用最多）。</p>
<p>测试声明式事务核心方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> DeclarativeTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">FooService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">    FooService fooService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertRecord</span><span class="params">()</span> &#123;</span><br><span class="line">        jdbcTemplate.execute(<span class="string">&quot;INSERT INTO FOO (BAR) VALUES (&#x27;AAA&#x27;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = RollbackException.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertThenRollback</span><span class="params">()</span> <span class="keyword">throws</span> RollbackException &#123;</span><br><span class="line">        jdbcTemplate.execute(<span class="string">&quot;INSERT INTO FOO (BAR) VALUES (&#x27;BBB&#x27;)&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RollbackException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeInsertThenRollback</span><span class="params">()</span> <span class="keyword">throws</span> RollbackException &#123;</span><br><span class="line">                <span class="comment">// 思考这两个方法的不同。</span></span><br><span class="line"><span class="comment">//        insertThenRollback();</span></span><br><span class="line">        fooService.insertThenRollback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始调用时需要开启事务注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> DeclarativeTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AdviceMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(mode = AdviceMode.PROXY)</span>   <span class="comment">// 开启事务注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeclarativeTransactionDemoApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    FooService fooService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeclarativeTransactionDemoApplication.class, args);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        fooService.insertRecord();</span><br><span class="line">        log.info(<span class="string">&quot;AAA: &#123;&#125;&quot;</span>, jdbcTemplate. queryForObject(<span class="string">&quot;SELECT COUNT(*) FROM FOO WHERE BAR=&#x27;AAA&#x27;&quot;</span>, Long.class));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fooService.insertThenRollback();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RollbackException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;BBB &#123;&#125;&quot;</span>,jdbcTemplate.queryForObject(<span class="string">&quot;SELECT COUNT(*) FROM FOO WHERE BAR=&#x27;BBB&#x27;&quot;</span>, Long.class));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fooService.invokeInsertThenRollback();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RollbackException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;BBB &#123;&#125;&quot;</span>,jdbcTemplate.queryForObject(<span class="string">&quot;SELECT COUNT(*) FROM FOO WHERE BAR=&#x27;BBB&#x27;&quot;</span>, Long.class));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> DeclarativeTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FooService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertRecord</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertThenRollback</span><span class="params">()</span> <span class="keyword">throws</span> RollbackException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeInsertThenRollback</span><span class="params">()</span> <span class="keyword">throws</span> RollbackException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> DeclarativeTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RollbackException</span> <span class="keyword">extends</span> <span class="title class_">Throwable</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="事务的传播特性"><a href="#事务的传播特性" class="headerlink" title="事务的传播特性"></a>事务的传播特性</h4><p><strong>TransactionDefinition.PROPAGATION_REQUIRED</strong><br>使用的最多的一个事务传播行为，我们平时经常使用的@Transactional注解默认使用就是这个事务传播行为。<br>如果当前存在事务，则加入该事务，不会创建新事务；如果当前没有事务，则创建一个新的事务。</p>
<p><strong>TransactionDefinition.PROPAGATION_REQUIRES_NEW</strong><br>始终新起一个事务，两个事务没有关联。</p>
<p><strong>TransactionDefinition.PROPAGATION_NESTED</strong></p>
<ul>
<li>有事务：在原事务内启动一个内嵌事务。两个事务有关联，外部事务回滚，内嵌事务也会回滚。</li>
</ul>
<p><strong>TransactionDefinition.PROPAGATION_MANDATORY</strong><br>如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。（mandatory：强制性）</p>
<p>代码实例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> DeclarativeTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">FooService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    FooService fooService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = RollbackException.class, propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertThenRollback</span><span class="params">()</span> <span class="keyword">throws</span> RollbackException &#123;</span><br><span class="line">        jdbcTemplate.execute(<span class="string">&quot;INSERT INTO FOO (BAR) VALUES (&#x27;BBB&#x27;)&quot;</span>);</span><br><span class="line">        <span class="comment">// throw new RollbackException();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = RollbackException.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeInsertThenRollback</span><span class="params">()</span> <span class="keyword">throws</span> RollbackException &#123;</span><br><span class="line">        jdbcTemplate.execute(<span class="string">&quot;INSERT INTO FOO (BAR) VALUES (&#x27;AAA&#x27;)&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fooService.insertThenRollback();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RollbackException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;RollbackException&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RollbackException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/../images/8d1542c72a220d01da05ce791304e2803b1fb05f16400305babfafdf9b0289bb.png" alt="事务的传播特性"></p>
<p><img src="/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/../images/fe7f6ebc510e9a192a19749197febf38cb9950cebdeae177e6a9c8daf9d89287.png" alt="事务的传播特性2">  </p>
<h3 id="7、慢-SQL-日志"><a href="#7、慢-SQL-日志" class="headerlink" title="7、慢 SQL 日志"></a>7、慢 SQL 日志</h3><p>开启慢 SQL 日志，设置超过 100ms 的sql为慢sql。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.druid.filter.stat.log-slow-sql=<span class="literal">true</span></span><br><span class="line">spring.datasource.druid.filter.stat.slow-sql-millis=<span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectForUpdate</span><span class="params">()</span>&#123;</span><br><span class="line">	jdbcTemplate.queryForObject(<span class="string">&quot;select id from foo where id = 1 for update&quot;</span>, Long.class);</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		Thread.sleep(<span class="number">200</span>);</span><br><span class="line">	&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> DeclarativeTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AdviceMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(mode = AdviceMode.PROXY)</span>   <span class="comment">// 开启事务注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeclarativeTransactionDemoApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    FooService fooService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeclarativeTransactionDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(dataSource.toString());</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; fooService.selectForUpdate()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; fooService.selectForUpdate()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.alibaba.druid.filter.stat.StatFilter: slow sql <span class="number">212</span> millis. select id from foo <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">for</span> update[]</span><br></pre></td></tr></table></figure>

<h2 id="第三章-O-R-Mapping-实践"><a href="#第三章-O-R-Mapping-实践" class="headerlink" title="第三章 O/R Mapping 实践"></a>第三章 O/R Mapping 实践</h2><p>ORM（Object/Relational Mapping）”对象-关系映射”。简单说，ORM 就是通过实例对象的语法，完成关系型数据库的操作的技术。</p>
<h3 id="1、Spring-Data-JPA"><a href="#1、Spring-Data-JPA" class="headerlink" title="1、Spring Data JPA"></a>1、Spring Data JPA</h3><p>Java 持久层框架访问数据库的方式大致分为两种。一种以 SQL 核心，封装一定程度的 JDBC 操作，比如： MyBatis。另一种是以 Java 实体类为核心，将实体类的和数据库表之间建立映射关系，也就是我们说的ORM框架，如：Hibernate、Spring Data JPA（Java Persistence API Java持久层API）。</p>
<p><strong>JPA、Hibernate、Spring Data JPA 之间的关系</strong></p>
<ul>
<li>JPA 是Java EE 5规范中提出的Java持久化接口（规范）。</li>
<li>Hibernate 是 JPA 的一种实现，是一个框架。</li>
<li>Spring Data JPA 是一种 JPA 的抽象层，底层依赖Hibernate</li>
</ul>
<p>推荐阅读: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/115507328">JPA、Hibernate、Spring Data JPA之间的关系</a></p>
<h4 id="Spring-Data-JPA-提供的支持"><a href="#Spring-Data-JPA-提供的支持" class="headerlink" title="Spring Data JPA 提供的支持"></a>Spring Data JPA 提供的支持</h4><ul>
<li>@EnableJpaRepositories</li>
<li>Repository 接口：<ul>
<li>CrudRepository&lt;T, ID&gt;</li>
<li>PagingAndSortingRepository&lt;T, ID&gt;</li>
<li>JpaRepository&lt;T, ID&gt;</li>
</ul>
</li>
<li>Repository 实现类：<ul>
<li>SimpleJpaRepository</li>
<li>QueryDslJpaRepository</li>
</ul>
</li>
</ul>
<h3 id="2、使用-Spring-Data-JPA-操作数据库"><a href="#2、使用-Spring-Data-JPA-操作数据库" class="headerlink" title="2、使用 Spring Data JPA 操作数据库"></a>2、使用 Spring Data JPA 操作数据库</h3><h4 id="创建实体（表）"><a href="#创建实体（表）" class="headerlink" title="创建实体（表）"></a>创建实体（表）</h4><p>使用SpringBoot内嵌的H2数据库。创建一个咖啡表和一个咖啡订单表。<br><strong>咖啡表</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.CreationTimestamp;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.Type;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.UpdateTimestamp;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span>	<span class="comment">// 实体</span></span><br><span class="line"><span class="meta">@Table(name = &quot;T_MENU&quot;)</span></span><br><span class="line"><span class="meta">@Builder</span>  <span class="comment">// @Builder声明表示实体可以使用Builder方式初始化</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Coffee</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="meta">@Type(type = &quot;org.jadira.usertype.moneyandcurrency.joda.PersistentMoneyMinorAmount&quot;,</span></span><br><span class="line"><span class="meta">    parameters = &#123;@org.hibernate.annotations.Parameter(name = &quot;currencyCode&quot;, value = &quot;CNY&quot;)&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> Money price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>咖啡订单表</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.OrderState;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Column;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Enumerated;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.JoinTable;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.ManyToMany;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.OrderBy;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Table;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;T_ORDER&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeeOrder</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String customer;</span><br><span class="line">    <span class="meta">@ManyToMany</span></span><br><span class="line">    <span class="meta">@JoinTable(name = &quot;T_ORDER_COFFEE&quot;)</span>	<span class="comment">// 创建一个 T_ORDER_COFFEE 表</span></span><br><span class="line">    <span class="meta">@OrderBy(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Coffee&gt; items;</span><br><span class="line">    <span class="meta">@Enumerated</span></span><br><span class="line">    <span class="meta">@Column(nullable = false)</span>	<span class="comment">// 可以为空</span></span><br><span class="line">    <span class="keyword">private</span> OrderState state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>父类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.CreationTimestamp;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.Type;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.UpdateTimestamp;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编写一个父类,将这些共同属性放到这个父类中, 并且在父类上加上@MappedSuperclass注解.注意:标注为@MappedSuperclass的类将不是一个完整的实体类，他将不会映射到数据库表，但是他的属性都将映射到其子类的数据库字段中。</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span>	</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseEntity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span>	<span class="comment">// 表示主键</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>	<span class="comment">// 主键生成规则</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Column(updatable = false)</span>	<span class="comment">// 不可以更新</span></span><br><span class="line">    <span class="meta">@CreationTimestamp</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="meta">@UpdateTimestamp</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现-操作数据库的接口"><a href="#实现-操作数据库的接口" class="headerlink" title="实现 操作数据库的接口"></a>实现 操作数据库的接口</h4><p>这些接口的命名是固定好的，只要按规定格式命名，Spring Boot JPA 就会帮我们做具体操作数据库的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.repository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.NoRepositoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.PagingAndSortingRepository;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoRepositoryBean</span>   <span class="comment">// 表示不会作为一个Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseRepository</span>&lt;T, Long&gt; <span class="keyword">extends</span> <span class="title class_">PagingAndSortingRepository</span>&lt;T, Long&gt; &#123;</span><br><span class="line">    List&lt;T&gt; <span class="title function_">findTop3ByOrderByUpdateTimeDescIdAsc</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>操作咖啡表的接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.repository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoffeeRepository</span> <span class="keyword">extends</span> <span class="title class_">BaseRepository</span>&lt;Coffee, Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>操作咖啡订单表的接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.repository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.CrudRepository;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoffeeOrderRepository</span> <span class="keyword">extends</span> <span class="title class_">BaseRepository</span>&lt;CoffeeOrder, Long&gt; &#123;</span><br><span class="line">    List&lt;CoffeeOrder&gt; <span class="title function_">findByCustomerOrderById</span><span class="params">(String customer)</span>;</span><br><span class="line">    List&lt;CoffeeOrder&gt; <span class="title function_">findByItems_Name</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeOrder;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.OrderState;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeOrderRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeOrderRepository orderRepository;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(CoffeApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		initOrders();</span><br><span class="line">		findOrders();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initOrders</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="type">Coffee</span> <span class="variable">espresso</span> <span class="operator">=</span> Coffee.builder().name(<span class="string">&quot;espresso&quot;</span>)</span><br><span class="line">				.price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">20.0</span>))</span><br><span class="line">				.build();</span><br><span class="line">		coffeeRepository.save(espresso);</span><br><span class="line">		log.info(<span class="string">&quot;Coffee: &#123;&#125;&quot;</span>, espresso);</span><br><span class="line"></span><br><span class="line">		<span class="type">Coffee</span> <span class="variable">latte</span> <span class="operator">=</span> Coffee.builder().name(<span class="string">&quot;latte&quot;</span>)</span><br><span class="line">				.price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">30.0</span>))</span><br><span class="line">				.build();</span><br><span class="line">		coffeeRepository.save(latte);</span><br><span class="line">		log.info(<span class="string">&quot;Coffee: &#123;&#125;&quot;</span>, latte);</span><br><span class="line"></span><br><span class="line">		<span class="type">CoffeeOrder</span> <span class="variable">order</span> <span class="operator">=</span> CoffeeOrder.builder()</span><br><span class="line">				.customer(<span class="string">&quot;Li Lei&quot;</span>)</span><br><span class="line">				.items(Collections.singletonList(espresso))	<span class="comment">// 创建不可变List的单个元素</span></span><br><span class="line">				.state(OrderState.INIT)</span><br><span class="line">				.build();</span><br><span class="line">		orderRepository.save(order);</span><br><span class="line">		log.info(<span class="string">&quot;Order: &#123;&#125;&quot;</span>, order);</span><br><span class="line"></span><br><span class="line">		order = CoffeeOrder.builder()</span><br><span class="line">				.customer(<span class="string">&quot;Li Lei&quot;</span>)</span><br><span class="line">				.items(Arrays.asList(espresso, latte))</span><br><span class="line">				.state(OrderState.INIT)</span><br><span class="line">				.build();</span><br><span class="line">		orderRepository.save(order);</span><br><span class="line">		log.info(<span class="string">&quot;Order: &#123;&#125;&quot;</span>, order);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">findOrders</span><span class="params">()</span> &#123;</span><br><span class="line">		coffeeRepository</span><br><span class="line">				.findAll(Sort.by(Sort.Direction.DESC, <span class="string">&quot;id&quot;</span>))</span><br><span class="line">				.forEach(c -&gt; log.info(<span class="string">&quot;Loading &#123;&#125;&quot;</span>, c));</span><br><span class="line"></span><br><span class="line">		List&lt;CoffeeOrder&gt; list = orderRepository.findTop3ByOrderByUpdateTimeDescIdAsc();</span><br><span class="line">		log.info(<span class="string">&quot;findTop3ByOrderByUpdateTimeDescIdAsc: &#123;&#125;&quot;</span>, getJoinedOrderId(list));</span><br><span class="line"></span><br><span class="line">		list = orderRepository.findByCustomerOrderById(<span class="string">&quot;Li Lei&quot;</span>);</span><br><span class="line">		log.info(<span class="string">&quot;findByCustomerOrderById: &#123;&#125;&quot;</span>, getJoinedOrderId(list));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 不开启事务会因为没Session而报LazyInitializationException</span></span><br><span class="line">		list.forEach(o -&gt; &#123;</span><br><span class="line">			log.info(<span class="string">&quot;Order &#123;&#125;&quot;</span>, o.getId());</span><br><span class="line">			o.getItems().forEach(i -&gt; log.info(<span class="string">&quot;  Item &#123;&#125;&quot;</span>, i));</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		list = orderRepository.findByItems_Name(<span class="string">&quot;latte&quot;</span>);</span><br><span class="line">		log.info(<span class="string">&quot;findByItems_Name: &#123;&#125;&quot;</span>, getJoinedOrderId(list));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">getJoinedOrderId</span><span class="params">(List&lt;CoffeeOrder&gt; list)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> list.stream().map(o -&gt; o.getId().toString())</span><br><span class="line">				.collect(Collectors.joining(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3、MyBatis-操作数据库"><a href="#3、MyBatis-操作数据库" class="headerlink" title="3、MyBatis 操作数据库"></a>3、MyBatis 操作数据库</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ityouknow/p/6037431.html">推荐阅读</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%203/mybatis-demo">代码仓库</a></li>
</ul>
<p>一款持久化框架，支持定制化SQL、存储过程和高级映射。JPA中SQL是框架自动生成的，MyBatis是自己手写的。结合 Mybatis 的官方 Demo 和文档可以将 Mybatis 的是用法总结为最简的两种模式：注解方式和XML方式。一般大型项目会使用XML方式，因为XML方式将SQL放在同一个XML文件中，方便对SQL进行优化。注解方式以注解形式将SQL添加在方法开头，开发方便，因此适合较小项目的开发。</p>
<h4 id="注解方式"><a href="#注解方式" class="headerlink" title="注解方式"></a>注解方式</h4><p>定义<code>Coffee</code>，其中 Price 使用<code>Joda-Money</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mybatis.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Coffee</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Money price;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建表：新建 schema.sql 文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_coffee (</span><br><span class="line">    id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    price <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    create_time <span class="type">timestamp</span>,</span><br><span class="line">    update_time <span class="type">timestamp</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p> Mapper sql语句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mybatis.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mybatis.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoffeeMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// insert into t_coffee (name, price, create_time, update_time) values (&quot;latte&quot;,30.0, &#x27;2022-05-06&#x27;, &#x27;2022-05-06&#x27;);</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into t_coffee (name, price, create_time, update_time) values (#&#123;name&#125;, #&#123;price&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;)&quot;)</span></span><br><span class="line">    <span class="meta">@Options(useGeneratedKeys = true, keyColumn = &quot;id&quot;, keyProperty = &quot;id&quot;)</span> <span class="comment">// 指定在数据库中的字段名 id，实例对象中主键的属性名 id。</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">save</span><span class="params">(Coffee coffee)</span>;    <span class="comment">// 返回的是变动记录的条数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// select * from t_coffee where id = #&#123;id&#125;</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from t_coffee where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@Results(&#123;</span></span><br><span class="line"><span class="meta">            @Result(id = true, column = &quot;id&quot;, property = &quot;id&quot;),</span></span><br><span class="line"><span class="meta">            @Result(column = &quot;create_time&quot;, property = &quot;createTime&quot;), // 实例对象名字为 create_time，数据库中名字为 createTime。</span></span><br><span class="line"><span class="meta">            // map-underscore-to-camel-case = true 可以实现一样的效果</span></span><br><span class="line"><span class="meta">            // @Result(column = &quot;update_time&quot;, property = &quot;updateTime&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="comment">// @Param(&quot;id&quot;)对应where id = #&#123;id&#125;里的#&#123;id&#125;，给个例子，万一大家以后变量名和参数名不一样，也好知道怎么写。</span></span><br><span class="line">    Coffee <span class="title function_">findById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引入类型转换的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 表示是类型转化时包的前缀</span><br><span class="line">mybatis.type-handlers-<span class="keyword">package</span>=com.example.mybatis.handler</span><br><span class="line"># 将下划线转化为驼峰规则</span><br><span class="line">mybatis.configuration.map-underscore-to-camel-<span class="keyword">case</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>定义自己的handle，用于处理Money的类型转换（类中使用 Money 类型的price，数据库中使用 bigint 类型的price）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mybatis.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.BaseTypeHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.JdbcType;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.CallableStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类中使用 Money 类型的price，数据库中使用 bigint 类型的price。</span></span><br><span class="line"><span class="comment"> * mybatis在没有配置handler时，会根据参数或者返回结果的不同，默认为我们选择合适的TypeHandler处理。</span></span><br><span class="line"><span class="comment"> * 当我们需要特殊的字段处理时，可以配置自己的handler。</span></span><br><span class="line"><span class="comment"> * 首先，在配置文件中引入 配置的包。</span></span><br><span class="line"><span class="comment"> * 然后，实现 BaseTypeHandler 接口完成自己的类。</span></span><br><span class="line"><span class="comment"> * 在 Money 与 Long 之间转换的 TypeHandler，处理 CNY 人民币</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MoneyTypeHandler</span> <span class="keyword">extends</span> <span class="title class_">BaseTypeHandler</span>&lt;Money&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i, Money parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        ps.setLong(i, parameter.getAmountMinorLong());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Money <span class="title function_">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> parseMoney(rs.getLong(columnName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Money <span class="title function_">getNullableResult</span><span class="params">(ResultSet rs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> parseMoney(rs.getLong(columnIndex));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Money <span class="title function_">getNullableResult</span><span class="params">(CallableStatement cs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> parseMoney(cs.getLong(columnIndex));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Money <span class="title function_">parseMoney</span><span class="params">(Long value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), value / <span class="number">100.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mybatis.mapper.CoffeeMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.mybatis.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.example.mybatis.mapper&quot;)</span>	<span class="comment">// 扫描对应包里边的mapper映射</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeMapper coffeeMapper;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(MybatisApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将 name 的值设置为 espresso，将price的值设置为 20.0。和sql中的$&#123;name&#125;和$&#123;price&#125;对应。</span></span><br><span class="line">		<span class="comment">// @Insert(&quot;insert into t_coffee (name, price, create_time, update_time) values (#&#123;name&#125;, #&#123;price&#125;, now(), now())&quot;)</span></span><br><span class="line">		<span class="type">Coffee</span> <span class="variable">coffee</span> <span class="operator">=</span> Coffee.builder().name(<span class="string">&quot;espresso&quot;</span>)</span><br><span class="line">				.price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">20.0</span>))</span><br><span class="line">				.createTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">				.updateTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">				.build();</span><br><span class="line">		<span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> coffeeMapper.save(coffee);</span><br><span class="line">		log.info(<span class="string">&quot;Save &#123;&#125; Coffee: &#123;&#125;&quot;</span>, count, coffee);</span><br><span class="line"></span><br><span class="line">		coffee = Coffee.builder().name(<span class="string">&quot;latte&quot;</span>)</span><br><span class="line">				.price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">25.0</span>))</span><br><span class="line">				.createTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">				.updateTime(<span class="keyword">new</span> <span class="title class_">Date</span>()).build();</span><br><span class="line">		count = coffeeMapper.save(coffee);</span><br><span class="line">		log.info(<span class="string">&quot;Save &#123;&#125; Coffee: &#123;&#125;&quot;</span>, count, coffee);</span><br><span class="line"></span><br><span class="line">		coffeeMapper.findById(coffee.getId());</span><br><span class="line">		log.info(<span class="string">&quot;Find Coffee: &#123;&#125;&quot;</span>, coffee);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="XML-方式"><a href="#XML-方式" class="headerlink" title="XML 方式"></a>XML 方式</h4><p><a target="_blank" rel="noopener" href="https://github.com/jiaoqiang2014/testMybatis">代码</a></p>
<h3 id="4、MaBatis-Generator"><a href="#4、MaBatis-Generator" class="headerlink" title="4、MaBatis Generator"></a>4、MaBatis Generator</h3><p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%203/mybatis-generator-demo">代码仓库</a></p>
<h3 id="5、MaBatis-PageHelper"><a href="#5、MaBatis-PageHelper" class="headerlink" title="5、MaBatis PageHelper"></a>5、MaBatis PageHelper</h3><p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%203/mybatis-pagehelper-demo">代码仓库</a></p>
<h2 id="第四章-NoSQL-实践"><a href="#第四章-NoSQL-实践" class="headerlink" title="第四章 NoSQL 实践"></a>第四章 NoSQL 实践</h2><h3 id="1、docker-的一些环境安装"><a href="#1、docker-的一些环境安装" class="headerlink" title="1、docker 的一些环境安装"></a>1、docker 的一些环境安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mongo -p 27017:27017 -v ~/docker-data/mongo:/data/db -e MONGO_INITDB_ROOT_USERNAME=admin -e MONGO_INITDB_ROOT_PASSWORD=admin -d mongo</span><br></pre></td></tr></table></figure>

<h3 id="2、MongoDB"><a href="#2、MongoDB" class="headerlink" title="2、MongoDB"></a>2、MongoDB</h3><p>MongoDB 是一款开源的文档型数据库。Spring 对 MongoDB 的支持：</p>
<ul>
<li>Spring Data MongoDB<ul>
<li>MongoTemplate</li>
<li>Repository 支持</li>
</ul>
</li>
<li>注解<ul>
<li>@Document 和 @Entity 类似，表示类是一个文档（@Entity中是表）</li>
<li>@Id 每个文档都会对应一个 Id ，通过@Id表明类中哪一个属性是id。加上 @Id 之后，Spring Data Mongo 会将属性的类型转化为 MongoDB 中的 object ID。</li>
</ul>
</li>
<li>MongoTemplate<ul>
<li>save / remove</li>
<li>Criteria / Query / Update</li>
</ul>
</li>
<li>Spring Data MongoDB 的 Repository<ul>
<li>@EnableMongoRepositories</li>
<li>对应接口<ul>
<li>MongoRepository&lt;T, ID&gt;</li>
<li>PagingAndSortingRepository&lt;T, ID&gt;</li>
<li>CrudRepository&lt;T, ID&gt;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="3、Spring-中访问-MongoDB"><a href="#3、Spring-中访问-MongoDB" class="headerlink" title="3、Spring 中访问 MongoDB"></a>3、Spring 中访问 MongoDB</h3><p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%204/mongo-demo">代码仓库</a></p>
<h4 id="3-1-安装-MongoDB"><a href="#3-1-安装-MongoDB" class="headerlink" title="3.1 安装 MongoDB"></a>3.1 安装 MongoDB</h4><p>使用 docker 安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">docker pull Mongo</span><br><span class="line">docker exec -it mongo bash</span><br><span class="line">mongo -u admin -p admin</span><br><span class="line"></span><br><span class="line">// 显示当前存在的库</span><br><span class="line">show dbs</span><br><span class="line"></span><br><span class="line">// 使用springbucks库，没有会默认创建一个</span><br><span class="line">use springbucks</span><br><span class="line"></span><br><span class="line">// 创建 createUser，用户名和密码都为springbucks。</span><br><span class="line">db.createUser(</span><br><span class="line">	&#123;</span><br><span class="line">		user: &quot;springbucks&quot;,</span><br><span class="line">		pwd: &quot;springbucks&quot;,</span><br><span class="line">		roles: [</span><br><span class="line">			&#123;role: &quot;readWrite&quot;, db: &quot;springbucks&quot;&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">show users</span><br><span class="line"></span><br><span class="line">show collections;</span><br><span class="line"></span><br><span class="line">db.coffee.find();</span><br><span class="line"></span><br><span class="line">// 删除 coffee 中所有名为 espresso 的 Document 。</span><br><span class="line">db.coffee.remove(&#123;&quot;name&quot;:&quot;espresso&quot;&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="3-2-基于-MongoTemplate-的方法"><a href="#3-2-基于-MongoTemplate-的方法" class="headerlink" title="3.2 基于 MongoTemplate 的方法"></a>3.2 基于 MongoTemplate 的方法</h4><h5 id="创建-Coffee-类"><a href="#创建-Coffee-类" class="headerlink" title="创建 Coffee 类"></a>创建 Coffee 类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mongo.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 表示类是一个文档</span></span><br><span class="line"><span class="meta">@Document</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Coffee</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;  <span class="comment">// 加上 @Id 之后，Spring Data Mongo 会将String类型转化为 MongoDB 中的 object ID。</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Money price;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="配置-MongoDB"><a href="#配置-MongoDB" class="headerlink" title="配置 MongoDB"></a>配置 MongoDB</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用户名密码对应 springbucks:springbucks ，使用 springbucks 库。</span><br><span class="line">spring.data.mongodb.uri=mongodb:<span class="comment">//springbucks:springbucks@124.220.171.2:27017/springbucks</span></span><br><span class="line">spring.main.allow-circular-references=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h5 id="编写特殊类型-Money-的转化代码（-Mongo-gt-Money-类型）"><a href="#编写特殊类型-Money-的转化代码（-Mongo-gt-Money-类型）" class="headerlink" title="编写特殊类型 Money 的转化代码（ Mongo -&gt; Money 类型）"></a>编写特殊类型 Money 的转化代码（ Mongo -&gt; Money 类型）</h5><p>从 Money 类型转化为 Mongo 中的 Document 是自动转化的，不需要我们自己手写。其实就是转化为 Dson 类型（和json相似）。<br><strong>mongo 中存储的 Coffee 对象格式如下，这是一条 Document</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;626b59f24eb80121ff790475&quot;</span>)<span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;espresso&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span></span><br><span class="line">	<span class="punctuation">&#123;</span> <span class="attr">&quot;money&quot;</span> <span class="punctuation">:</span></span><br><span class="line">		<span class="punctuation">&#123;</span> <span class="attr">&quot;currency&quot;</span> <span class="punctuation">:</span></span><br><span class="line">			<span class="punctuation">&#123;</span> <span class="attr">&quot;code&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CNY&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;numericCode&quot;</span> <span class="punctuation">:</span> <span class="number">156</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;decimalPlaces&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;amount&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;20.00&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;createTime&quot;</span> <span class="punctuation">:</span> ISODate(<span class="string">&quot;2022-04-29T03:22:26.240Z&quot;</span>)<span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;updateTime&quot;</span> <span class="punctuation">:</span> ISODate(<span class="string">&quot;2022-04-29T03:22:26.240Z&quot;</span>)<span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_class&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;com.example.mongo.model.Coffee&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Mongo -&gt; Money 类型</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mongo.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bson.Document;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.Converter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Document 转化为 Money。</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MoneyReadConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;Document, Money&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Money <span class="title function_">convert</span><span class="params">(Document source)</span> &#123;</span><br><span class="line">        <span class="comment">// Mongo 取出 Document 的数据，从中取出 money。</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">money</span> <span class="operator">=</span> (Document) source.get(<span class="string">&quot;money&quot;</span>);</span><br><span class="line">        <span class="comment">// 从 money 中解析出金额。</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">amount</span> <span class="operator">=</span> Double.parseDouble(money.getString(<span class="string">&quot;amount&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">currency</span> <span class="operator">=</span> ((Document) money.get(<span class="string">&quot;currency&quot;</span>)).getString(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Money.of(CurrencyUnit.of(currency), amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调用代码"><a href="#调用代码" class="headerlink" title="调用代码"></a>调用代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mongo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mongo.converter.MoneyReadConverter;</span><br><span class="line"><span class="keyword">import</span> com.example.mongo.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.result.UpdateResult;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.internal.bulk.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.ClientSessionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.MongoCustomConversions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.data.mongodb.core.query.Criteria.where;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.data.mongodb.core.query.Query.query;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(MongoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查看 spring-boot-autoconfigure -&gt; data -&gt; mongo -&gt; MongoDataAutoConfiguration.class</span></span><br><span class="line">	<span class="comment">// 可以看出构造一个 MongoCustomConversions 类型的 bean ，可以替代 MongoDataAutoConfiguration 中的一部分配置。</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> MongoCustomConversions <span class="title function_">mongoCustomConversions</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MongoCustomConversions</span>(Arrays.asList(<span class="keyword">new</span> <span class="title class_">MoneyReadConverter</span>()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//插入</span></span><br><span class="line">		<span class="type">Coffee</span> <span class="variable">espresso</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">				.name(<span class="string">&quot;espresso&quot;</span>)</span><br><span class="line">				.price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">20.0</span>))</span><br><span class="line">				.createTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">				.updateTime(<span class="keyword">new</span> <span class="title class_">Date</span>()).build();</span><br><span class="line">		<span class="type">Coffee</span> <span class="variable">saved</span> <span class="operator">=</span> mongoTemplate.save(espresso);</span><br><span class="line">		log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, saved);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 查询</span></span><br><span class="line">		List&lt;Coffee&gt; list = mongoTemplate.find(query(where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;espresso&quot;</span>)), Coffee.class);</span><br><span class="line">		log.info(<span class="string">&quot;Find &#123;&#125; Coffee&quot;</span>, list.size());</span><br><span class="line">		list.forEach(c -&gt; log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, c));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新</span></span><br><span class="line">		Thread.sleep(<span class="number">1000</span>); <span class="comment">// 为了看更新时间 1s</span></span><br><span class="line">		<span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.updateFirst(query(where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;espresso&quot;</span>)),</span><br><span class="line">				 <span class="keyword">new</span> <span class="title class_">Update</span>().set(<span class="string">&quot;price&quot;</span>, Money.ofMajor(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">30</span>))</span><br><span class="line">						 .currentDate(<span class="string">&quot;updateTime&quot;</span>),</span><br><span class="line">				 Coffee.class);</span><br><span class="line">		 log.info(<span class="string">&quot;Update Result: &#123;&#125;&quot;</span>, result.getModifiedCount());</span><br><span class="line"></span><br><span class="line">		 <span class="type">Coffee</span> <span class="variable">updateOne</span> <span class="operator">=</span> mongoTemplate.findById(saved.getId(), Coffee.class);</span><br><span class="line">		 log.info(<span class="string">&quot;Update Result: &#123;&#125;&quot;</span>, updateOne);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 删除</span></span><br><span class="line">		 mongoTemplate.remove(updateOne);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-基于-Spring-Data-MongoDB-的-Repository-的方法"><a href="#3-3-基于-Spring-Data-MongoDB-的-Repository-的方法" class="headerlink" title="3.3 基于 Spring Data MongoDB 的 Repository 的方法"></a>3.3 基于 Spring Data MongoDB 的 Repository 的方法</h4><p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%204/mongo-repository-demo">代码仓库</a><br><strong>在基于 MongoTemplate 的方法基础上实现 MongoRepository 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mongo.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mongo.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoffeeRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;Coffee, String&gt; &#123;</span><br><span class="line">    List&lt;Coffee&gt; <span class="title function_">findByName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>添加<code>@EnableMongoRepositories</code>注解，修改调用代码如下</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mongo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mongo.converter.MoneyReadConverter;</span><br><span class="line"><span class="keyword">import</span> com.example.mongo.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.example.mongo.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.result.UpdateResult;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.internal.bulk.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.ClientSessionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.MongoCustomConversions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Update;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.repository.config.EnableMongoRepositories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.data.mongodb.core.query.Criteria.where;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.data.mongodb.core.query.Query.query;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(MongoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查看 spring-boot-autoconfigure -&gt; data -&gt; mongo -&gt; MongoDataAutoConfiguration.class</span></span><br><span class="line">	<span class="comment">// 可以看出构造一个 MongoCustomConversions 类型的 bean ，可以替代 MongoDataAutoConfiguration 中的一部分配置。</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> MongoCustomConversions <span class="title function_">mongoCustomConversions</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MongoCustomConversions</span>(Arrays.asList(<span class="keyword">new</span> <span class="title class_">MoneyReadConverter</span>()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//插入</span></span><br><span class="line">		<span class="type">Coffee</span> <span class="variable">espresso</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">				.name(<span class="string">&quot;espresso&quot;</span>)</span><br><span class="line">				.price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">20.0</span>))</span><br><span class="line">				.createTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">				.updateTime(<span class="keyword">new</span> <span class="title class_">Date</span>()).build();</span><br><span class="line">		<span class="type">Coffee</span> <span class="variable">latte</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">				.name(<span class="string">&quot;latte&quot;</span>)</span><br><span class="line">				.price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">30.0</span>))</span><br><span class="line">				.createTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">				.updateTime(<span class="keyword">new</span> <span class="title class_">Date</span>()).build();</span><br><span class="line"></span><br><span class="line">		coffeeRepository.insert(Arrays.asList(espresso, latte));</span><br><span class="line">		coffeeRepository.findAll(Sort.by(<span class="string">&quot;name&quot;</span>)).forEach(c -&gt; log.info(<span class="string">&quot;Saved Coffee &#123;&#125;&quot;</span>, c));</span><br><span class="line"></span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		latte.setPrice(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), <span class="number">35.0</span>));</span><br><span class="line">		latte.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">		coffeeRepository.save(latte);</span><br><span class="line">		coffeeRepository.findByName(<span class="string">&quot;latte&quot;</span>).forEach(c -&gt; log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, c));</span><br><span class="line">		coffeeRepository.deleteAll();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="4、Redis"><a href="#4、Redis" class="headerlink" title="4、Redis"></a>4、Redis</h3><p>Spring 对 Redis 的支持 – Spring Data Redis</p>
<ul>
<li>支持客户端Jedis / Lettuce</li>
<li>RedisTemplate</li>
<li>Repository 支持</li>
</ul>
<h4 id="Jedis-客户端的简单使用-代码仓库"><a href="#Jedis-客户端的简单使用-代码仓库" class="headerlink" title="Jedis 客户端的简单使用-代码仓库"></a>Jedis 客户端的简单使用-<a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%204/jedis-demo">代码仓库</a></h4><ul>
<li>Jedis 不是线程安全的</li>
<li>通过 JedisPool 获得 Jedis 实例。<br><strong>原因：</strong> Jedis 不安全，不能在多个线程中中使用同一个 jeid ，因此使用 JedisPool 管理 jedis，每次使用时从 JedisPool 中取。</li>
<li>直接使用 Jedis 中的方法</li>
</ul>
<p><strong>实现功能</strong><br>在前面 MongDB 的基础上，使用 Jedis 连接 Redis ，并且测试基本的增删改查。</p>
<p><strong>新建 scheme.sql 文件。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">drop table t_coffee <span class="keyword">if</span> exists;</span><br><span class="line">drop table t_order <span class="keyword">if</span> exists;</span><br><span class="line">drop table t_order_coffee <span class="keyword">if</span> exists;</span><br><span class="line"></span><br><span class="line">create table <span class="title function_">t_coffee</span> <span class="params">(</span></span><br><span class="line"><span class="params">    id bigint auto_increment,</span></span><br><span class="line"><span class="params">    create_time timestamp,</span></span><br><span class="line"><span class="params">    update_time timestamp,</span></span><br><span class="line"><span class="params">    name varchar(<span class="number">255</span>)</span>,</span><br><span class="line">    price bigint,</span><br><span class="line">    primary <span class="title function_">key</span> <span class="params">(id)</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table <span class="title function_">t_order</span> <span class="params">(</span></span><br><span class="line"><span class="params">    id bigint auto_increment,</span></span><br><span class="line"><span class="params">    create_time timestamp,</span></span><br><span class="line"><span class="params">    update_time timestamp,</span></span><br><span class="line"><span class="params">    customer varchar(<span class="number">255</span>)</span>,</span><br><span class="line">    state integer not <span class="literal">null</span>,</span><br><span class="line">    primary <span class="title function_">key</span> <span class="params">(id)</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table <span class="title function_">t_order_coffee</span> <span class="params">(</span></span><br><span class="line"><span class="params">    coffee_order_id bigint not <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    items_id bigint not <span class="literal">null</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>新建 data.sql 文件。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;espresso&#x27;</span>, <span class="number">2000</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;latte&#x27;</span>, <span class="number">2500</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;capuccino&#x27;</span>, <span class="number">2500</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;mocha&#x27;</span>, <span class="number">3000</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;macchiato&#x27;</span>, <span class="number">3000</span>, now(), now());</span><br></pre></td></tr></table></figure>
<p><strong>配置 Jedis</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring.jpa.hibernate.ddl-auto=none</span><br><span class="line">spring.jpa.properties.hibernate.show_sql=<span class="literal">true</span></span><br><span class="line">spring.jpa.properties.hibernate.form_sql=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"># redis</span><br><span class="line">redis.host=<span class="number">124.220</span><span class="number">.171</span><span class="number">.2</span></span><br><span class="line">redis.password=<span class="number">123456</span></span><br><span class="line">redis.port=<span class="number">6379</span></span><br><span class="line">redis.maxTotal=<span class="number">5</span></span><br><span class="line">redis.maxIdle=<span class="number">5</span></span><br><span class="line"># 向资源池借用连接时是否做连接有效性检测（ping）。检测到的无效连接将会被移除。</span><br><span class="line">redis.testOnBorrow=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">spring.main.allow-circular-references=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>测试 Jedis 代码。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeOrder;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.OrderState;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeOrderRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeOrderService;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.text.html.Option;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeService coffeeService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeOrderService coffeeOrderService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JedisPoolConfig jedisPoolConfig;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(CoffeApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		log.info(<span class="string">&quot;All Coffee: &#123;&#125;&quot;</span>, coffeeRepository.findAll());</span><br><span class="line">		Optional&lt;Coffee&gt; mocha = coffeeService.findOneCoffee(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		Optional&lt;Coffee&gt; latte = coffeeService.findOneCoffee(<span class="string">&quot;latte&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">CoffeeOrder</span> <span class="variable">order</span> <span class="operator">=</span> coffeeOrderService.createOrder(<span class="string">&quot;Li Lei&quot;</span>, mocha.get(), latte.get());</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;Update INIT to PAID: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.PAID));</span><br><span class="line">		log.info(<span class="string">&quot;Update PAID to INIT: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.INIT));</span><br><span class="line"></span><br><span class="line"><span class="comment">//		testRedis();</span></span><br><span class="line">		testJedis();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConfigurationProperties(&quot;redis&quot;)</span>	<span class="comment">// 解析配置文件中 redis 开头的选项。</span></span><br><span class="line">	<span class="keyword">public</span> JedisPoolConfig <span class="title function_">jedisPoolConfig</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean(destroyMethod = &quot;close&quot;)</span>	<span class="comment">// Bean 关闭时调用他的close方法。</span></span><br><span class="line">	<span class="keyword">public</span> JedisPool <span class="title function_">jedisPool</span><span class="params">(<span class="meta">@Value(&quot;$&#123;redis.host&#125;&quot;)</span> String host)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JedisPool</span>(jedisPoolConfig(), host);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedis</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">try</span> (<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource()) &#123;</span><br><span class="line">			jedis.set(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;1233&quot;</span>);</span><br><span class="line"></span><br><span class="line">			<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> jedis.get(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">			log.info(<span class="string">&quot;Menu: &#123;&#125;&quot;</span>, value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJedis</span><span class="params">()</span>&#123;</span><br><span class="line">		log.info(jedisPoolConfig.toString());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> (<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource()) &#123;</span><br><span class="line">			coffeeService.findAllCoffee().forEach(c -&gt; &#123;</span><br><span class="line">				jedis.hset(<span class="string">&quot;springbucks-menu&quot;</span>,</span><br><span class="line">						c.getName(),</span><br><span class="line">						Long.toString(c.getPrice().getAmountMinorLong()));</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			Map&lt;String, String&gt; menu = jedis.hgetAll(<span class="string">&quot;springbucks-menu&quot;</span>);</span><br><span class="line">			log.info(<span class="string">&quot;Menu: &#123;&#125;&quot;</span>, menu);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Redis-的两种部署方式"><a href="#Redis-的两种部署方式" class="headerlink" title="Redis 的两种部署方式"></a>Redis 的两种部署方式</h4><ul>
<li>哨兵模式</li>
<li>集群模式</li>
</ul>
<h5 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h5><p>Redis Sentinel 是 Redis 的一种高可用方案。</p>
<ul>
<li>监控、通知、自动故障转移、服务发现</li>
</ul>
<p><strong>哨兵</strong><br>JedisSentinePool</p>
<p><strong>集群</strong><br>Redis Cluster</p>
<ul>
<li>数据自动分片（分成16384个Hash Slot）</li>
<li>在部分节点失效时有一定的可用性</li>
</ul>
<p>JedisCluster</p>
<ul>
<li>Jedis 只从 Master 读数据，如果想要自动读写分离，可以定制</li>
</ul>
<h3 id="5、Spring-Boot-缓存抽象"><a href="#5、Spring-Boot-缓存抽象" class="headerlink" title="5、Spring Boot 缓存抽象"></a>5、Spring Boot 缓存抽象</h3><h4 id="Spring-boot-为不同的缓存提供一层抽象"><a href="#Spring-boot-为不同的缓存提供一层抽象" class="headerlink" title="Spring boot 为不同的缓存提供一层抽象"></a>Spring boot 为不同的缓存提供一层抽象</h4><ul>
<li>为java方法增加缓存，缓存执行结果</li>
<li>支持 Redis、ConcurrentMap、EhCache、Caffeine、JCache（JSR-107）等缓存抽象</li>
<li>接口<ul>
<li>org.springframework.cache.Cache</li>
<li>org.springframework.cache.CacheManager</li>
</ul>
</li>
</ul>
<h4 id="Spring-boot-默认缓存（本地缓存）-代码仓库"><a href="#Spring-boot-默认缓存（本地缓存）-代码仓库" class="headerlink" title="Spring boot 默认缓存（本地缓存） - 代码仓库"></a>Spring boot 默认缓存（本地缓存） - <a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%204/cache-demo">代码仓库</a></h4><p>Spring boot 自带的默认缓存，也可以集成 Redis、EhCache等其他缓存。</p>
<p><strong>EnableCaching</strong>    开启缓存支持</p>
<ul>
<li><p>@Cacheable <br>Spring会在其被调用后将其返回值缓存起来，以保证下次利用同样的参数来执行该方法时可以直接从缓存中获取结果，而不需要再次执行该方法。Spring在缓存方法的返回值时是以键值对进行缓存的，值就是方法的返回结果。</p>
</li>
<li><p>@CacheEvict <br>@CachEvict主要针对方法配置，能够根据一定的条件对特定的缓存进行清空。该注解有两个特别的属性：</p>
<ul>
<li>allEntries 是否清空所有缓存内容，缺省为 false，如果指定为 true，则方法调用后将立即清空所有缓存。注意不能跟key参数同时使用。</li>
<li>beforeInvocation 是否在方法执行前就清空，缺省为 false，如果指定为 true，则在方法还没有执行的时候就清空缓存，缺省情况下，如果方法执行抛出异常，则不会清空缓存。</li>
</ul>
</li>
<li><p>@CachePut <br>@CachePut每次都将执行方法并将返回值K-V放入缓存，如果该K存在则进行更新。</p>
</li>
<li><p>@Caching <br>该注解是个组合注解。有时候我们需要在一个方法上同时使用多个相同注解但是java是不支持一个注解在同一个方法上多次使用。这时就可以使用该注解进行组合。</p>
</li>
<li><p>@CacheConfig <br>作用于缓存接口上，来对该接口下的一些重复配置（缓存名称、key生成器、缓存管理器、缓存处理器）进行归纳处理。其他属性可参考Cacheable。</p>
</li>
</ul>
<p><strong>流程</strong></p>
<ul>
<li>开启缓存支持（@EnableCaching(proxyTargetClass = true)    // 开启缓存支持）</li>
<li>配置缓存（@CacheConfig(cacheNames = “coffee”) // 该缓存的名字为coffee）</li>
<li>指定缓存的具体方法</li>
</ul>
<p><strong>配置缓存和为方法添加缓存注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Example;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.ExampleMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.data.domain.ExampleMatcher.GenericPropertyMatchers.exact;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CacheConfig(cacheNames = &quot;coffee&quot;)</span> <span class="comment">// 该缓存的名字为coffee。（类级别共享的缓存配置）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Coffee&gt; <span class="title function_">findOneCoffee</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        Example&lt;Coffee&gt; example = <span class="keyword">new</span> <span class="title class_">Example</span>&lt;Coffee&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Coffee <span class="title function_">getProbe</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Coffee.builder().name(name).build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ExampleMatcher <span class="title function_">getMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">ExampleMatcher</span> <span class="variable">exampleMatcher</span> <span class="operator">=</span> ExampleMatcher.matching().withMatcher(<span class="string">&quot;name&quot;</span>, exact().ignoreCase());</span><br><span class="line">                <span class="keyword">return</span> exampleMatcher;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Optional&lt;Coffee&gt;  coffee = coffeeRepository.findOne(example);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;Coffee Found: &#123;&#125;&quot;</span>, coffee);</span><br><span class="line">        <span class="keyword">return</span> coffee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span> <span class="comment">// 为该方法添加缓存</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Coffee&gt; <span class="title function_">findAllCoffee</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> coffeeRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict</span> <span class="comment">// 清除缓存</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reloadCoffee</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>开启缓存支持</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeOrder;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.OrderState;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeOrderRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeOrderService;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.text.html.Option;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableCaching(proxyTargetClass = true)</span>	<span class="comment">// 开启缓存支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeOrderRepository orderRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeService coffeeService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeOrderService coffeeOrderService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(CoffeApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		log.info(<span class="string">&quot;All Coffee: &#123;&#125;&quot;</span>, coffeeRepository.findAll());</span><br><span class="line">		Optional&lt;Coffee&gt; mocha = coffeeService.findOneCoffee(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		Optional&lt;Coffee&gt; latte = coffeeService.findOneCoffee(<span class="string">&quot;latte&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">CoffeeOrder</span> <span class="variable">order</span> <span class="operator">=</span> coffeeOrderService.createOrder(<span class="string">&quot;Li Lei&quot;</span>, mocha.get(), latte.get());</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;Update INIT to PAID: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.PAID));</span><br><span class="line">		log.info(<span class="string">&quot;Update PAID to INIT: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.INIT));</span><br><span class="line"></span><br><span class="line">		testSpringCache();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpringCache</span><span class="params">()</span>&#123;</span><br><span class="line">		log.info(<span class="string">&quot;Count: &#123;&#125;&quot;</span>, coffeeService.findAllCoffee().size());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			log.info(<span class="string">&quot;Reading from cache.&quot;</span>);</span><br><span class="line">			coffeeService.findAllCoffee();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		coffeeService.reloadCoffee();</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;Reading after refresh.&quot;</span>);</span><br><span class="line"></span><br><span class="line">		coffeeService.findAllCoffee().forEach(c -&gt; log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, c.getName()));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="集成-redis-缓存"><a href="#集成-redis-缓存" class="headerlink" title="集成 redis 缓存"></a>集成 redis 缓存</h4><p><strong>依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置缓存</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">none</span></span><br><span class="line"><span class="attr">spring.jpa.properties.hibernate.show_sql</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.jpa.properties.hibernate.format_sql</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management.endpoints.web.exposure.include</span>=<span class="string">*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#使用redis缓存</span></span><br><span class="line"><span class="attr">spring.cache.type</span>=<span class="string">redis</span></span><br><span class="line"><span class="comment">#配置默认缓存的，启动时会把其中指定的缓存创建出来，运行时的缓存不能超出我这指定的范围（有同学反馈这个与底层的缓存实现有关，因此补充一下，比如Simple的不能超过，但Redis的可以），不配的话就看代码里用到哪些动态创建。@CacheConfig用来配置类级别共享的缓存配置，配置不在@CacheConfig里，就需要加在@Cacheable里。</span></span><br><span class="line"><span class="attr">spring.cache.cache-names</span>=<span class="string">coffee</span></span><br><span class="line"><span class="comment">#在缓存中的存活时间</span></span><br><span class="line"><span class="attr">spring.cache.redis.time-to-live</span>=<span class="string">5000</span></span><br><span class="line"><span class="attr">spring.cache.redis.cache-null-values</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">localhost</span></span><br></pre></td></tr></table></figure>

<p><strong>配置缓存和为方法添加缓存注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@CacheConfig(cacheNames = &quot;coffee&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeeService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Coffee&gt; <span class="title function_">findAllCoffee</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> coffeeRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reloadCoffee</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Coffee&gt; <span class="title function_">findOneCoffee</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">ExampleMatcher</span> <span class="variable">matcher</span> <span class="operator">=</span> ExampleMatcher.matching()</span><br><span class="line">                .withMatcher(<span class="string">&quot;name&quot;</span>, exact().ignoreCase());</span><br><span class="line">        Optional&lt;Coffee&gt; coffee = coffeeRepository.findOne(</span><br><span class="line">                Example.of(Coffee.builder().name(name).build(), matcher));</span><br><span class="line">        log.info(<span class="string">&quot;Coffee Found: &#123;&#125;&quot;</span>, coffee);</span><br><span class="line">        <span class="keyword">return</span> coffee;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>调用代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeOrder;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.OrderState;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeOrderRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeOrderService;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.text.html.Option;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableCaching(proxyTargetClass = true)</span>	<span class="comment">// 开启缓存支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeService coffeeService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeOrderService coffeeOrderService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JedisPoolConfig jedisPoolConfig;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(CoffeApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		log.info(<span class="string">&quot;All Coffee: &#123;&#125;&quot;</span>, coffeeRepository.findAll());</span><br><span class="line">		Optional&lt;Coffee&gt; mocha = coffeeService.findOneCoffee(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		Optional&lt;Coffee&gt; latte = coffeeService.findOneCoffee(<span class="string">&quot;latte&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">CoffeeOrder</span> <span class="variable">order</span> <span class="operator">=</span> coffeeOrderService.createOrder(<span class="string">&quot;Li Lei&quot;</span>, mocha.get(), latte.get());</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;Update INIT to PAID: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.PAID));</span><br><span class="line">		log.info(<span class="string">&quot;Update PAID to INIT: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.INIT));</span><br><span class="line">		testRedisCache();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisCache</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">		log.info(<span class="string">&quot;Count: &#123;&#125;&quot;</span>, coffeeService.findAllCoffee().size());</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">			log.info(<span class="string">&quot;Reading from cache.&quot;</span>);</span><br><span class="line">			coffeeService.findAllCoffee();</span><br><span class="line">		&#125;</span><br><span class="line">		Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">		log.info(<span class="string">&quot;Reading after refresh.&quot;</span>);</span><br><span class="line">		coffeeService.findAllCoffee().forEach(c -&gt; log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, c.getName()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpringCache</span><span class="params">()</span>&#123;</span><br><span class="line">		log.info(<span class="string">&quot;Count: &#123;&#125;&quot;</span>, coffeeService.findAllCoffee().size());</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			log.info(<span class="string">&quot;Reading from cache.&quot;</span>);</span><br><span class="line">			coffeeService.findAllCoffee();</span><br><span class="line">		&#125;</span><br><span class="line">		coffeeService.reloadCoffee();</span><br><span class="line">		log.info(<span class="string">&quot;Reading after refresh.&quot;</span>);</span><br><span class="line">		coffeeService.findAllCoffee().forEach(c -&gt; log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, c.getName()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConfigurationProperties(&quot;redis&quot;)</span>	<span class="comment">// 解析配置文件中 redis 开头的选项。</span></span><br><span class="line">	<span class="keyword">public</span> JedisPoolConfig <span class="title function_">jedisPoolConfig</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean(destroyMethod = &quot;close&quot;)</span>	<span class="comment">// Bean 关闭时调用他的close方法。</span></span><br><span class="line">	<span class="keyword">public</span> JedisPool <span class="title function_">jedisPool</span><span class="params">(<span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span> String host)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JedisPool</span>(jedisPoolConfig(), host);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、Redis-在-Spring-中的其他用法"><a href="#6、Redis-在-Spring-中的其他用法" class="headerlink" title="6、Redis 在 Spring 中的其他用法"></a>6、Redis 在 Spring 中的其他用法</h3><h4 id="与-Redis-建立连接"><a href="#与-Redis-建立连接" class="headerlink" title="与 Redis 建立连接"></a>与 Redis 建立连接</h4><p><strong>配置连接工厂</strong></p>
<ul>
<li>LettuceConnecetionFactory 与 JedisConnectionFactory<ul>
<li>RedsiStandaloneConfiguration</li>
<li>RedsiaSentinelConfiguration</li>
<li>RedsiClusterConfiguraion</li>
</ul>
</li>
</ul>
<h4 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h4><p><strong>Lettuce 内置支持读写分离</strong></p>
<ul>
<li>只读主、只读从</li>
<li>优先读主、优先读从</li>
</ul>
<p>LettuceClientConfiguration    <br>LettucePollingClientConfiguration    <br>LettuceClientConfigurationBuildercustonizer</p>
<h4 id="RedisTemplate"><a href="#RedisTemplate" class="headerlink" title="RedisTemplate"></a>RedisTemplate</h4><p><strong>对Redis 的操作一定设置过期时间！！！</strong><br><strong>对Redis 的操作一定设置过期时间！！！</strong><br><strong>对Redis 的操作一定设置过期时间！！！</strong></p>
<p>RedisTemplate&lt;K, V&gt;</p>
<ul>
<li>opsForXxx()</li>
</ul>
<p>StringRedisTemplate</p>
<p><strong>配置 RedisTemplate</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeOrder;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.OrderState;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeOrderRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeOrderService;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.text.html.Option;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeService coffeeService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeOrderService coffeeOrderService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(CoffeApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;All Coffee: &#123;&#125;&quot;</span>, coffeeRepository.findAll());</span><br><span class="line">		Optional&lt;Coffee&gt; mocha = coffeeService.findOneCoffee(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		Optional&lt;Coffee&gt; latte = coffeeService.findOneCoffee(<span class="string">&quot;latte&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">CoffeeOrder</span> <span class="variable">order</span> <span class="operator">=</span> coffeeOrderService.createOrder(<span class="string">&quot;Li Lei&quot;</span>, mocha.get(), latte.get());</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;Update INIT to PAID: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.PAID));</span><br><span class="line">		log.info(<span class="string">&quot;Update PAID to INIT: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.INIT));</span><br><span class="line">		testRedisTemplate();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	* 配置 RedisTemplate</span></span><br><span class="line"><span class="comment">	* */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> RedisTemplate&lt;String, Coffee&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123;</span><br><span class="line">		RedisTemplate&lt;String, Coffee&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">		template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">		<span class="keyword">return</span> template;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">		Optional&lt;Coffee&gt; c = coffeeService.findOneCoffee(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">			coffeeService.findOneCoffee(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		log.info(<span class="string">&quot;Value from Redis: &#123;&#125;&quot;</span>, c);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体的操作</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Example;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.ExampleMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.HashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.data.domain.ExampleMatcher.GenericPropertyMatchers.exact;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeeService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE</span> <span class="operator">=</span> <span class="string">&quot;springbucks-coffee&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate&lt;String, Coffee&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Coffee&gt; <span class="title function_">findOneCoffee</span><span class="params">(String name)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询缓存</span></span><br><span class="line">        <span class="comment">// HashOperations&lt;String, String, Coffee&gt; 用于存储 Map 类型，第一个 String 是Reids中key的一部分；</span></span><br><span class="line">        <span class="comment">// 第二个String是map中的key，Coffee是map的value；一个map是redis中的value</span></span><br><span class="line">        HashOperations&lt;String, String, Coffee&gt; hashOperations = redisTemplate.opsForHash();</span><br><span class="line">        <span class="keyword">if</span> (redisTemplate.hasKey(CACHE) &amp;&amp; hashOperations.hasKey(CACHE, name))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get coffee &#123;&#125; from Redsi.&quot;</span>, name);</span><br><span class="line">            <span class="keyword">return</span> Optional.of(hashOperations.get(CACHE, name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hashOperations.get(CACHE, name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入数据库</span></span><br><span class="line">        Example&lt;Coffee&gt; example = <span class="keyword">new</span> <span class="title class_">Example</span>&lt;Coffee&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Coffee <span class="title function_">getProbe</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Coffee.builder().name(name).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ExampleMatcher <span class="title function_">getMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">ExampleMatcher</span> <span class="variable">exampleMatcher</span> <span class="operator">=</span> ExampleMatcher.matching().withMatcher(<span class="string">&quot;name&quot;</span>, exact().ignoreCase());</span><br><span class="line">                <span class="keyword">return</span> exampleMatcher;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Optional&lt;Coffee&gt;  coffee = coffeeRepository.findOne(example);</span><br><span class="line">        log.info(<span class="string">&quot;Coffee Found: &#123;&#125;&quot;</span>, coffee);</span><br><span class="line">        <span class="comment">// 写入缓存</span></span><br><span class="line">        <span class="keyword">if</span> (coffee.isPresent())&#123;</span><br><span class="line">            log.info(<span class="string">&quot;Put coffee &#123;&#125; to Redis.&quot;</span>, name);</span><br><span class="line">            hashOperations.put(CACHE, name, coffee.get());</span><br><span class="line">            redisTemplate.expire(CACHE, <span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> coffee;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Redis-Repository"><a href="#Redis-Repository" class="headerlink" title="Redis Repository"></a>Redis Repository</h4><p>实体注解</p>
<ul>
<li>@RedisHash （类似Entity）</li>
<li>@Id</li>
<li>@Indexed （二级索引）</li>
</ul>
<h5 id="出了不同类型（JPA、Mongn、Redis）数据源的-Repository"><a href="#出了不同类型（JPA、Mongn、Redis）数据源的-Repository" class="headerlink" title="出了不同类型（JPA、Mongn、Redis）数据源的 Repository"></a>出了不同类型（JPA、Mongn、Redis）数据源的 Repository</h5><p>如何区分这些 Repsitory</p>
<ul>
<li>根据实体的注解</li>
<li>根据继承的接口类型</li>
<li>扫描不同的包</li>
</ul>
<h4 id="Redis-Repository-的简单实例"><a href="#Redis-Repository-的简单实例" class="headerlink" title="Redis Repository 的简单实例"></a>Redis Repository 的简单实例</h4><ul>
<li>配置 redis</li>
<li>开启 Redis Repositories 的支持</li>
<li>类中的特殊类型自定义 RedisCustomConversions</li>
<li>实现具体操作</li>
</ul>
<p><strong>配置 Redis</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># redis</span><br><span class="line">spring.redis.host=<span class="number">124.220</span><span class="number">.171</span><span class="number">.2</span></span><br><span class="line">spring.redis.password=<span class="number">123456</span></span><br><span class="line">spring.redis.port=<span class="number">6379</span></span><br><span class="line">spring.redis.maxTotal=<span class="number">5</span></span><br><span class="line">spring.redis.maxIdle=<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p><strong>ReisHash</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisHash;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.index.Indexed;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RedisHash(value = &quot;springbucks-coffee&quot;, timeToLive = 60)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeeCache</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Money price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现 CrudRepository 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeCache;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.CrudRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoffeeCacheRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;CoffeeCache, Long&gt; &#123;</span><br><span class="line">    Optional&lt;CoffeeCache&gt; <span class="title function_">findOneByName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现特殊类型（Money）写入到 Reids 的转化</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.Converter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.convert.WritingConverter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入到 Redis 中</span></span><br><span class="line"><span class="meta">@WritingConverter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MoneyToBytesConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;Money, <span class="type">byte</span>[]&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] convert(Money source) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> Long.toString(source.getAmountMinorLong());</span><br><span class="line">        <span class="keyword">return</span> value.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现特殊类型（Money）从 Reids 中读出转化为 Money</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.Converter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.convert.ReadingConverter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ReadingConverter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BytesToMoneyConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;<span class="type">byte</span>[], Money&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Money <span class="title function_">convert</span><span class="params">(<span class="type">byte</span>[] source)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(source, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">return</span> Money.ofMinor(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), Long.parseLong(value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>将自定义的 Converter 注入到容器中</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RedisCustomConversions <span class="title function_">redisCustomConversions</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisCustomConversions</span>(Arrays.asList(<span class="keyword">new</span> <span class="title class_">MoneyToBytesConverter</span>(), <span class="keyword">new</span> <span class="title class_">BytesToMoneyConverter</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现 Service 层具体的操作</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeCache;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeCacheRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Example;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.ExampleMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.HashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.data.domain.ExampleMatcher.GenericPropertyMatchers.exact;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeeService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE</span> <span class="operator">=</span> <span class="string">&quot;springbucks-coffee&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoffeeRepository coffeeRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate&lt;String, Coffee&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoffeeCacheRepository coffeeCacheRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Coffee&gt; <span class="title function_">findOneCoffee</span><span class="params">(String name)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询缓存</span></span><br><span class="line">        <span class="comment">// HashOperations&lt;String, String, Coffee&gt; 用于存储 Map 类型，第一个 String 是Reids中key的一部分；</span></span><br><span class="line">        <span class="comment">// 第二个String是map中的key，Coffee是map的value；一个map是redis中的value</span></span><br><span class="line">        HashOperations&lt;String, String, Coffee&gt; hashOperations = redisTemplate.opsForHash();</span><br><span class="line">        <span class="keyword">if</span> (redisTemplate.hasKey(CACHE) &amp;&amp; hashOperations.hasKey(CACHE, name))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;Get coffee &#123;&#125; from Redsi.&quot;</span>, name);</span><br><span class="line">            <span class="keyword">return</span> Optional.of(hashOperations.get(CACHE, name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hashOperations.get(CACHE, name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入数据库</span></span><br><span class="line">        Example&lt;Coffee&gt; example = <span class="keyword">new</span> <span class="title class_">Example</span>&lt;Coffee&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Coffee <span class="title function_">getProbe</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Coffee.builder().name(name).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ExampleMatcher <span class="title function_">getMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">ExampleMatcher</span> <span class="variable">exampleMatcher</span> <span class="operator">=</span> ExampleMatcher.matching().withMatcher(<span class="string">&quot;name&quot;</span>, exact().ignoreCase());</span><br><span class="line">                <span class="keyword">return</span> exampleMatcher;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Optional&lt;Coffee&gt;  coffee = coffeeRepository.findOne(example);</span><br><span class="line">        log.info(<span class="string">&quot;Coffee Found: &#123;&#125;&quot;</span>, coffee);</span><br><span class="line">        <span class="comment">// 写入缓存</span></span><br><span class="line">        <span class="keyword">if</span> (coffee.isPresent())&#123;</span><br><span class="line">            log.info(<span class="string">&quot;Put coffee &#123;&#125; to Redis.&quot;</span>, name);</span><br><span class="line">            hashOperations.put(CACHE, name, coffee.get());</span><br><span class="line">            redisTemplate.expire(CACHE, <span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> coffee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Coffee&gt; <span class="title function_">findSimpleCoffeeFromCache</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        Optional&lt;CoffeeCache&gt; cached = coffeeCacheRepository.findOneByName(name);</span><br><span class="line">        <span class="keyword">if</span> (cached.isPresent())&#123;</span><br><span class="line">            <span class="type">CoffeeCache</span> <span class="variable">coffeeCache</span> <span class="operator">=</span> cached.get();</span><br><span class="line">            <span class="type">Coffee</span> <span class="variable">coffee</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">                    .name(coffeeCache.getName())</span><br><span class="line">                    .price(coffeeCache.getPrice()).build();</span><br><span class="line">            log.info(<span class="string">&quot;Coffee &#123;&#125; found in cache.&quot;</span>, coffeeCache);</span><br><span class="line">            <span class="keyword">return</span> Optional.of(coffee);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            Optional&lt;Coffee&gt; raw = findOneCoffee(name);</span><br><span class="line"></span><br><span class="line">            raw.ifPresent(c -&gt; &#123;</span><br><span class="line">                <span class="type">CoffeeCache</span> <span class="variable">coffeeCache</span> <span class="operator">=</span> CoffeeCache.builder()</span><br><span class="line">                        .id(c.getId())</span><br><span class="line">                        .name(c.getName())</span><br><span class="line">                        .price(c.getPrice()).build();</span><br><span class="line">                log.info(<span class="string">&quot;Save Coffee &#123;&#125; to cache.&quot;</span>, coffeeCache);</span><br><span class="line">                coffeeCacheRepository.save(coffeeCache);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> raw;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jq.coffe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.converter.BytesToMoneyConverter;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.converter.MoneyToBytesConverter;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.CoffeeOrder;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.model.OrderState;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeOrderRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.repository.CoffeeRepository;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeOrderService;</span><br><span class="line"><span class="keyword">import</span> com.jq.coffe.service.CoffeeService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.convert.RedisCustomConversions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.repository.configuration.EnableRedisRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.text.html.Option;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableRedisRepositories</span>	<span class="comment">// 开启Redis Repositories 的支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeRepository coffeeRepository;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeService coffeeService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	CoffeeOrderService coffeeOrderService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(CoffeApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		log.info(<span class="string">&quot;All Coffee: &#123;&#125;&quot;</span>, coffeeRepository.findAll());</span><br><span class="line">		Optional&lt;Coffee&gt; mocha = coffeeService.findOneCoffee(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		Optional&lt;Coffee&gt; latte = coffeeService.findOneCoffee(<span class="string">&quot;latte&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">CoffeeOrder</span> <span class="variable">order</span> <span class="operator">=</span> coffeeOrderService.createOrder(<span class="string">&quot;Li Lei&quot;</span>, mocha.get(), latte.get());</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;Update INIT to PAID: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.PAID));</span><br><span class="line">		log.info(<span class="string">&quot;Update PAID to INIT: &#123;&#125;&quot;</span>, coffeeOrderService.updateState(order, OrderState.INIT));</span><br><span class="line">		testRedisRepository();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将自定义的 Converter 注入到容器中</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> RedisCustomConversions <span class="title function_">redisCustomConversions</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisCustomConversions</span>(Arrays.asList(<span class="keyword">new</span> <span class="title class_">MoneyToBytesConverter</span>(), <span class="keyword">new</span> <span class="title class_">BytesToMoneyConverter</span>()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisRepository</span><span class="params">()</span>&#123;</span><br><span class="line">		Optional&lt;Coffee&gt; c = coffeeService.findSimpleCoffeeFromCache(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		log.info(<span class="string">&quot;Coffee &#123;&#125;&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">			c = coffeeService.findSimpleCoffeeFromCache(<span class="string">&quot;mocha&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		log.info(<span class="string">&quot;Value from Redis: &#123;&#125;&quot;</span>, c);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第五章-数据访问进阶"><a href="#第五章-数据访问进阶" class="headerlink" title="第五章 数据访问进阶"></a>第五章 数据访问进阶</h2><h3 id="1、Project-Reactor-介绍"><a href="#1、Project-Reactor-介绍" class="headerlink" title="1、Project Reactor 介绍"></a>1、Project Reactor 介绍</h3><p><strong>Reactor Programming（响应式编程）:</strong> c = a + b; 当结果计算出来之后，a和b变化，c不在受影响，Reactor 编程可以将变化传给c。<br><strong>Reactor Programming（响应式编程）</strong> 是一种基于数据流（data stream）和变化传递（propagation of change）的声明式（declarative）的编程范式。具体理解强烈推荐 - <a target="_blank" rel="noopener" href="https://blog.csdn.net/get_set/article/details/79455258">什么是响应式编程</a>。</p>
<p>必读 - <a target="_blank" rel="noopener" href="https://blog.csdn.net/get_set/article/details/79480172">Reactor 3 快速上手</a>,该专栏其他文章也建议阅读。</p>
<h5 id="一些核心概念"><a href="#一些核心概念" class="headerlink" title="一些核心概念"></a>一些核心概念</h5><p><strong>Publisher / Subscriber</strong></p>
<ul>
<li>Nothing Happens Until You subscribe() </li>
<li>Flux [ 0..N ] - onNext()、onComplete()、onError()</li>
<li>Mono [ 0..1 ] - onNext()、onComplete()、onError() </li>
</ul>
<p><strong>Backpressure （“回压”机制）</strong></p>
<ul>
<li>Subscription </li>
<li>onRequest(n) 指定每次订阅n个序列</li>
<li>onCancel() 取消订阅的过程</li>
<li>onDispose() 终止订阅的过程</li>
</ul>
<p><strong>线程调度 Schedulers</strong></p>
<ul>
<li>immediate() 当前在哪个线程上</li>
<li>single() 独占一个线程</li>
<li>newSingle()</li>
<li>elastic() elastic 的一个线程池，里面线程空闲60s就会被回收</li>
<li>parallel() 与CPU核数相对应的线程池，线程不会被回收</li>
<li>newParallel()  </li>
</ul>
<p><strong>错误处理</strong></p>
<ul>
<li>onError 类似 try catch</li>
<li>onErrorReturn 出现异常返回特定值</li>
<li>onErrorResume 出现异常使用特定的Lambda的处理异常</li>
<li>doOnError</li>
<li>doFinally 正常执行完还是遇到异常，都会执行 doFinally 中的方法。</li>
</ul>
<p><strong>依赖</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;io.projectreactor&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;reactor-core&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Demo</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 在调用 subscribe 方法之前不会有任何实际的动作</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 创建包含从 0 起始的 6 个数量的 Integer 对象的序列（数据流），其实就是将其打包起来，或者理解成声明，在 执行 subscribe 方法前什么都不会发生。</span></span><br><span class="line">		Flux.range(<span class="number">0</span>, <span class="number">6</span>)</span><br><span class="line">				.publishOn(Schedulers.elastic())	<span class="comment">// 发布到 Schedulers.elastic() 上</span></span><br><span class="line">				.doOnRequest(n -&gt; log.info(<span class="string">&quot;Request &#123;&#125; number&quot;</span>, n))</span><br><span class="line">				.doOnComplete(() -&gt; log.info(<span class="string">&quot;Publisher Complete&quot;</span>))	<span class="comment">// 当整个序列完成时执行</span></span><br><span class="line">				.map(i -&gt; &#123;</span><br><span class="line">					log.info(<span class="string">&quot;Publish &#123;&#125;, &#123;&#125;&quot;</span>, Thread.currentThread(), i);</span><br><span class="line">					<span class="keyword">return</span> <span class="number">10</span> / (i - <span class="number">3</span>);</span><br><span class="line"><span class="comment">//					return i;</span></span><br><span class="line">				&#125;)</span><br><span class="line"><span class="comment">//				.onErrorReturn(-1)	// 异常，发布-1，并返回</span></span><br><span class="line">				.onErrorResume(e -&gt; &#123;	<span class="comment">// 异常处理逻辑</span></span><br><span class="line">					log.error(<span class="string">&quot;Exception &#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">					<span class="keyword">return</span> Mono.just(-<span class="number">1</span>);</span><br><span class="line">				&#125;)</span><br><span class="line">				.doOnComplete(() -&gt; log.info(<span class="string">&quot;Publish Complete 2&quot;</span>))</span><br><span class="line">				.subscribeOn(Schedulers.single())	<span class="comment">// 指定从 Schedulers.single() 订阅</span></span><br><span class="line">				.subscribe(i -&gt; log.info(<span class="string">&quot;Subscribe &#123;&#125;: &#123;&#125;&quot;</span>, Thread.currentThread(), i),	<span class="comment">// 订阅</span></span><br><span class="line">						e -&gt; log.error(<span class="string">&quot;error &#123;&#125;&quot;</span>, e.toString()),</span><br><span class="line">						() -&gt; log.info(<span class="string">&quot;Subscribe Complete&quot;</span>),</span><br><span class="line">						s -&gt; s.request(<span class="number">4</span>)	<span class="comment">// 取出 4 个，“回压”机制</span></span><br><span class="line">	);</span><br><span class="line">		Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、Reactor-方式访问-Redis"><a href="#2、Reactor-方式访问-Redis" class="headerlink" title="2、Reactor 方式访问 Redis"></a>2、Reactor 方式访问 Redis</h3><p>Spring Data Redis 中的客户端 Lettuce 支持 Reactive 方式，Jedis不支持。</p>
<h4 id="Spring-Data-Redis-中对-Reactive-的支持"><a href="#Spring-Data-Redis-中对-Reactive-的支持" class="headerlink" title="Spring Data Redis 中对 Reactive 的支持"></a>Spring Data Redis 中对 Reactive 的支持</h4><ul>
<li>ReactiveRedisConnection</li>
<li>ReactiveRedisConnectionFactory</li>
<li>ReactiveRedistemplate<ul>
<li>opsForXxx()</li>
</ul>
</li>
</ul>
<p>使用 ReactiveRedisConnection 建立连接，这个连接是通过 ReactiveRedisConnectionFactory 构造的，与 Redistemplate 类似提供了 ReactiveRedistemplate。</p>
<h5 id="一个简单的通过-Reactor-能力访问-Redis-的例子"><a href="#一个简单的通过-Reactor-能力访问-Redis-的例子" class="headerlink" title="一个简单的通过 Reactor 能力访问 Redis 的例子"></a>一个简单的通过 Reactor 能力访问 Redis 的例子</h5><p><strong>创建表</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table t_coffee <span class="keyword">if</span> exists;</span><br><span class="line"></span><br><span class="line">create table <span class="title function_">t_coffee</span> <span class="params">(</span></span><br><span class="line"><span class="params">    id bigint auto_increment,</span></span><br><span class="line"><span class="params">    create_time timestamp,</span></span><br><span class="line"><span class="params">    update_time timestamp,</span></span><br><span class="line"><span class="params">    name varchar(<span class="number">255</span>)</span>,</span><br><span class="line">    price bigint,</span><br><span class="line">    primary <span class="title function_">key</span> <span class="params">(id)</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>插入数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;espresso&#x27;</span>, <span class="number">2000</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;latte&#x27;</span>, <span class="number">2500</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;capuccino&#x27;</span>, <span class="number">2500</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;mocha&#x27;</span>, <span class="number">3000</span>, now(), now());</span><br><span class="line">insert into <span class="title function_">t_coffee</span> <span class="params">(name, price, create_time, update_time)</span> values (<span class="string">&#x27;macchiato&#x27;</span>, <span class="number">3000</span>, now(), now());</span><br></pre></td></tr></table></figure>

<p><strong>构造对应的类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.reactor_redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Coffee</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Long price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>主要代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.reactor_redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.ReactiveListCommands;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.ReactiveHashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.ReactiveStringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"><span class="keyword">import</span> reactor.core.scheduler.Schedulers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY</span> <span class="operator">=</span> <span class="string">&quot;COFFEE_MENU&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	JdbcTemplate jdbcTemplate;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	ReactiveStringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	* 使用 ReactiveRedisConnectionFactory 配置连接</span></span><br><span class="line"><span class="comment">	* */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	ReactiveStringRedisTemplate <span class="title function_">reactiveStringRedisTemplate</span> <span class="params">(ReactiveRedisConnectionFactory factory)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactiveStringRedisTemplate</span>(factory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		ReactiveHashOperations&lt;String, String, String&gt; hasOps = redisTemplate.opsForHash();</span><br><span class="line">		<span class="type">CountDownLatch</span> <span class="variable">cdl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		List&lt;Coffee&gt; list = jdbcTemplate.query(<span class="string">&quot;select * from t_coffee&quot;</span>, (rs, i) -&gt;</span><br><span class="line">			Coffee.builder()</span><br><span class="line">					.id(rs.getLong(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">					.name(rs.getString(<span class="string">&quot;name&quot;</span>))</span><br><span class="line">					.price(rs.getLong(<span class="string">&quot;price&quot;</span>))</span><br><span class="line">					.build());</span><br><span class="line"></span><br><span class="line">		Flux.fromIterable(list)</span><br><span class="line">				.publishOn(Schedulers.single())	<span class="comment">// 调用一个单线程</span></span><br><span class="line">				.doOnComplete(() -&gt; log.info(<span class="string">&quot;list ok&quot;</span>))</span><br><span class="line">				.flatMap(c -&gt; &#123;	<span class="comment">// flatMap将元素映射为流。map操作可以将数据元素进行转换/映射，得到一个新元素。</span></span><br><span class="line">					log.info(<span class="string">&quot;try to put &#123;&#125;, &#123;&#125;&quot;</span>, c.getName(), c.getPrice());</span><br><span class="line">					<span class="keyword">return</span> hasOps.put(KEY, c.getName(), c.getPrice().toString());</span><br><span class="line">				&#125;)</span><br><span class="line">				.doOnComplete(() -&gt; log.info(<span class="string">&quot;set to redis ok&quot;</span>))</span><br><span class="line">				.concatWith(redisTemplate.expire(KEY, Duration.ofMinutes(<span class="number">1</span>)))	<span class="comment">// 设置有效期</span></span><br><span class="line">				.doOnComplete(() -&gt; log.info(<span class="string">&quot;set expire ok&quot;</span>))</span><br><span class="line">				.onErrorResume(e -&gt; &#123;</span><br><span class="line">					log.error(<span class="string">&quot;exception &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">					<span class="keyword">return</span> Mono.just(<span class="literal">false</span>);	<span class="comment">// just就是一种比较直接的声明数据流的方式，其参数就是数据元素。</span></span><br><span class="line">				&#125;)</span><br><span class="line">				.subscribe(b -&gt; log.info(b.toString()),</span><br><span class="line">						e -&gt; log.error(<span class="string">&quot;Exception &#123;&#125;&quot;</span>, e.getMessage()),</span><br><span class="line">						() -&gt; cdl.countDown()); <span class="comment">// 等待前面的执行完</span></span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">&quot;Waiting&quot;</span>);</span><br><span class="line">		cdl.await();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在Redis中查看</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br><span class="line">hgetall COFFEE_MENU</span><br></pre></td></tr></table></figure>

<h3 id="3、Reactive-方式访问-MongoDB"><a href="#3、Reactive-方式访问-MongoDB" class="headerlink" title="3、Reactive 方式访问 MongoDB"></a>3、Reactive 方式访问 MongoDB</h3><p><strong>MongoDB 官方提供了支持 Reactive 的驱动</strong></p>
<ul>
<li>mongodb-driver-reactivestreams</li>
</ul>
<p><strong>Spring Data MongoDB 中对 Reactive 的支持</strong></p>
<ul>
<li>ReactiveMongoClientFactoryBean</li>
<li>ReactiveMongoDatabaseFactory</li>
<li>ReactiveMongoTemplate</li>
</ul>
<h3 id="4、Reactive-方式访问-RDBMS"><a href="#4、Reactive-方式访问-RDBMS" class="headerlink" title="4、Reactive 方式访问 RDBMS"></a>4、Reactive 方式访问 RDBMS</h3><h4 id="Spring-Data-R2DBC"><a href="#Spring-Data-R2DBC" class="headerlink" title="Spring Data R2DBC"></a>Spring Data R2DBC</h4><p><strong>R2DBC （<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-r2dbc%EF%BC%89">https://spring.io/projects/spring-data-r2dbc）</a></strong></p>
<ul>
<li>Reactive Relational Database Connectivity </li>
</ul>
<p><strong>支持的数据库</strong></p>
<ul>
<li>Postgres（io.r2dbc:r2dbc-postgresql） </li>
<li>H2（io.r2dbc:r2dbc-h2） </li>
<li>Microsoft SQL Server（io.r2dbc:r2dbc-mssql）</li>
</ul>
<p><strong>Spring Data R2DBC 提供的主要的类</strong></p>
<ul>
<li>ConnectionFactory  </li>
<li>DatabaseClient</li>
<li>execute().sql(SQL) </li>
<li>inTransaction(db -&gt; {})   </li>
<li>R2dbcExceptionTranslator  </li>
<li>SqlErrorCodeR2dbcExceptionTranslator</li>
</ul>
<h4 id="R2DBC-Repository-⽀支持"><a href="#R2DBC-Repository-⽀支持" class="headerlink" title="R2DBC Repository ⽀支持"></a>R2DBC Repository ⽀支持</h4><p>一些主要的类 </p>
<ul>
<li>@EnableR2dbcRepositories  </li>
<li>ReactiveCrudRepository&lt;T, ID&gt;  <ul>
<li>@Table / @Id  </li>
<li>其中的⽅法返回都是 Mono 或者 Flux  </li>
<li>自定义查询需要⾃自⼰己写 @Query </li>
</ul>
</li>
</ul>
<h3 id="5、通过-AOP-打印数据访问层摘要"><a href="#5、通过-AOP-打印数据访问层摘要" class="headerlink" title="5、通过 AOP 打印数据访问层摘要"></a>5、通过 AOP 打印数据访问层摘要</h3><h4 id="AOP-面向切面编程"><a href="#AOP-面向切面编程" class="headerlink" title="AOP (面向切面编程)"></a>AOP (面向切面编程)</h4><p><strong>AOP (Aspect OrientedProgramming):</strong> 利用AOP可以对边缘业务进行隔离，降低无关业务逻辑耦合性。提高程序的可重用性，同时提高了开发的效率。<br><strong>使用场景：</strong> 一般用于日志记录，性能统计，安全控制，权限管理，事务处理，异常处理，资源池管理。</p>
<h4 id="Spring-AOP-的⼀些核心概念"><a href="#Spring-AOP-的⼀些核心概念" class="headerlink" title="Spring AOP 的⼀些核心概念"></a>Spring AOP 的⼀些核心概念</h4><ul>
<li>Aspect： 切⾯</li>
<li>Join Point： 连接点，Spring AOP里总是代表一次⽅法执行</li>
<li>Advice： 通知，在连接点执行的动作</li>
<li>Pointcut： 切入点，说明如何匹配连接点</li>
<li>Introduction： 引入，为现有类型声明额外的⽅法和属性</li>
<li>Target object： 目标对象</li>
<li>AOP proxy： AOP 代理对象，可以是 JDK 动态代理，也可以是 CGLIB 代理</li>
<li>Weaving： 织⼊，连接切⾯与⽬标对象或类型创建代理的过程</li>
</ul>
<h4 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h4><ul>
<li>@EnableAspectJAutoProxy 开启 Aspect 的支持，对于添加该注解的相关类去做一个 Proxy。</li>
<li>@Aspect 声明类是一个切面，另外需要添加一个可以成为Bean的注解。</li>
<li>通知注解<ul>
<li>@Pointcut    <a target="_blank" rel="noopener" href="https://blog.51cto.com/u_5914679/2092253">切点表达式写法</a></li>
<li>@Before</li>
<li>@After 运行结束去 Advice</li>
<li>@AfterReturning 返回之后 Advice</li>
<li>@AfterThrowing 抛出异常才去做 Advice</li>
<li>@Around 在被通知的方法调用之前和调用之后执行自定义的方法</li>
</ul>
</li>
<li>Order 指定切面的执行顺序</li>
</ul>
<h4 id="AOP-流程"><a href="#AOP-流程" class="headerlink" title="AOP 流程"></a>AOP 流程</h4><ul>
<li>声明切面（@Aspect）</li>
<li>定义切点（@Pointcut）</li>
<li>定义通知（@Before / @After / @AfterReturning / @AfterThrowing / @Around）</li>
</ul>
<h4 id="性能拦截器的简单例子"><a href="#性能拦截器的简单例子" class="headerlink" title="性能拦截器的简单例子"></a>性能拦截器的简单例子</h4><p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%205/performance-aspect-demo">代码仓库</a></p>
<h5 id="PS：如何打印SQL"><a href="#PS：如何打印SQL" class="headerlink" title="PS：如何打印SQL"></a>PS：如何打印SQL</h5><ul>
<li>HikariCP: 本身不支持SQL输出，可以依赖 P6Spy 的库实现。</li>
<li>Alibaba Druid<ul>
<li>具有内置的 SQL 输出。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/Druid">https://github.com/alibaba/druid/wiki/Druid</a> 中使⽤ log4j2 进行⽇志输出 </li>
</ul>
</li>
</ul>
<p>实例中使用 HikariCP 所以使用 P6Spy</p>
<h5 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>p6spy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>p6spy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置-p6spy"><a href="#配置-p6spy" class="headerlink" title="配置 p6spy"></a>配置 p6spy</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.p6spy.engine.spy.P6SpyDriver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:p6spy:h2:mem:testdb</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">sa</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string"></span></span><br></pre></td></tr></table></figure>

<h5 id="新建-psy-properties-添加-p6spy-配置"><a href="#新建-psy-properties-添加-p6spy-配置" class="headerlink" title="新建 psy.properties 添加 p6spy 配置"></a>新建 psy.properties 添加 p6spy 配置</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单行日志</span></span><br><span class="line"><span class="attr">logMessageFormat</span>=<span class="string">com.p6spy.engine.spy.appender.SingleLineFormat</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 使用Slf4J记录sql</span></span><br><span class="line"><span class="attr">appender</span>=<span class="string">com.p6spy.engine.spy.appender.Slf4JLogger</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 是否开启慢SQL记录</span></span><br><span class="line"><span class="attr">outagedetection</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 慢SQL记录标准，单位秒</span></span><br><span class="line"><span class="attr">outagedetectioninterval</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>

<h5 id="声明切面、定义切点和通知"><a href="#声明切面、定义切点和通知" class="headerlink" title="声明切面、定义切点和通知"></a>声明切面、定义切点和通知</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1、声明切面</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3、定义通知</span></span><br><span class="line">    <span class="meta">@Around(&quot;repositoryOps()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">logPerformance</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;_&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">			 <span class="comment">// 获取方法的名字</span></span><br><span class="line">            name = pjp.getSignature().toShortString();</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Throwable t)&#123;</span><br><span class="line">            result = <span class="string">&quot;N&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> t;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            log.info(<span class="string">&quot;&#123;&#125;; &#123;&#125;; &#123;&#125;ms&quot;</span>, name, result, endTime - startTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 2、定义切点</span></span><br><span class="line">	<span class="comment">// 增强 com.jq.coffe.repository 包下面的所有方法</span></span><br><span class="line">	<span class="comment">// execution 表示当&quot;()&quot;中指定的方法执行时被触发；第一个 &quot;*&quot; 表示返回任意类型；&quot;com.jq.coffe.repository&quot; 表示包名；</span></span><br><span class="line">    <span class="comment">// 第一个 &quot;..&quot; 表示 repository 包及其子包；第二个 &quot;*&quot; 表示任意类；&quot;(..)&quot; 表示方法的任意参数个数</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.jq.coffe.repository..*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">repositoryOps</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第六章-Spring-MVC"><a href="#第六章-Spring-MVC" class="headerlink" title="第六章 Spring MVC"></a>第六章 Spring MVC</h2><p><strong>Spring MVC 基本概念</strong><br>DispatcherServlet</p>
<ul>
<li>Controller</li>
<li>xxxResolver<ul>
<li>ViewResolver</li>
<li>HandleExceptionResolver</li>
<li>MultipartResolver</li>
</ul>
</li>
<li>HandlerMapping</li>
</ul>
<p><strong>Spring MVC常用注解</strong></p>
<ul>
<li>@Controller<ul>
<li>RestController (= @Controller + @ResponseBody)</li>
</ul>
</li>
<li>RequetMapping<ul>
<li>@GetMapping / @PostMapping</li>
<li>@PutMapping / @DeleteMapping</li>
</ul>
</li>
<li>@RequestBody / @ResponseBody / @ResponseBody</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%206/simple-controller-demo">一个简单的 Controller 实例</a></p>
<h3 id="1、Spring-Application-Context"><a href="#1、Spring-Application-Context" class="headerlink" title="1、Spring Application Context"></a>1、Spring Application Context</h3><p><strong>关于上下文常用的接口及其实现</strong></p>
<ul>
<li>BeanFactory<ul>
<li>DefaultListableBeanFactory</li>
</ul>
</li>
<li>ApplicationContext<ul>
<li>ClassPathXmlApplicationContext</li>
<li>FileSystemXmlApplicationContext</li>
<li>AnnotationConfigApplicationContext</li>
</ul>
</li>
<li>WebApplicationContext</li>
</ul>
<p>一般情况下不直接使用 BeanFactory ，而是使用 ApplicationContext 。</p>
<p><strong>Spring Web MVC 中的上下文层次结构</strong></p>
<p><img src="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/images/mvc-contexts.gif" alt="Spring Web MVC 中的上下文层次结构"></p>
<p>Spring Web MVC 上下文主要包含 Servlet WebApplicationContext 和 root WebApplicationContext，Servlet WebApplicationContext 继承 root WebApplicationContext。Servlet WebApplicationContext 主要包含 Controller、ViewResolver、handlerMapping等的Bean。root WebApplicationContext，Servlet 包含 Service、Repositories 等的Bean。程序先去 Servlet WebApplicationContext 中找 Bean ，如果找不到会进一步去 root WebApplicationContext 中找。在 AOP 增强时，如果需要增强子类中的 Bean，需要将增强放到子类的上下文中，如果需要增强父类中的 Bean，需要将增强放到父类的上下文中。如果是通用的将其放在父类中。<a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%206/context-hierarchy-demo">代码</a>如下，<a target="_blank" rel="noopener" href="https://time.geekbang.org/course/detail/100023501-85418">视频讲解</a>。</p>
<p><strong>写一个需要增强的类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.context.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String context;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;hello &quot;</span> + context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>增强代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.context.foo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;bean(testBean*)&quot;)</span>  <span class="comment">// 以 testBean 开头的Bean返回时增强</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printAfter</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;after hello()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用注解创建几个Bean，供后面增强功能测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.context.foo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.context.model.TestBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TestBean <span class="title function_">testBeanX</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TestBean</span>(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TestBean <span class="title function_">testBeanY</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TestBean</span>(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增强</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FooAspect <span class="title function_">fooAspect</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FooAspect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用XML创建几个Bean，供后面增强功能测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:aop=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:aspectj-autoproxy/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 定义一个 id 为 testBeanX 的 Bean --&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;testBeanX&quot;</span> class=<span class="string">&quot;com.example.context.model.TestBean&quot;</span>&gt;</span><br><span class="line">        &lt;!-- constructor-arg 是构造函数，构造函数初始化成员变量 --&gt;</span><br><span class="line">        &lt;constructor-arg name=<span class="string">&quot;context&quot;</span> value=<span class="string">&quot;Bar&quot;</span> /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!--    定义一个 Bean，和下面的代码功能一样--&gt;</span><br><span class="line">&lt;!--    <span class="meta">@Bean</span>--&gt;</span><br><span class="line">&lt;!--    <span class="keyword">public</span> FooAspect <span class="title function_">fooAspect</span><span class="params">()</span>&#123;--&gt;</span><br><span class="line">&lt;!--        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FooAspect</span>();--&gt;</span><br><span class="line">&lt;!--    &#125;--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;fooAspect&quot;</span> class=<span class="string">&quot;com.example.context.foo.FooAspect&quot;</span> /&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.context.foo.FooConfig;</span><br><span class="line"><span class="keyword">import</span> com.example.context.model.TestBean;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(ContextApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 加载 FooConfig 类中的一个 Context</span></span><br><span class="line">		<span class="type">ApplicationContext</span> <span class="variable">fooContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(FooConfig.class);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使用给定的 fooContext 为父级，创建一个新的 ClassPathXmlApplicationContext，从给定的 XML 文件加载定义并自动刷新上下文。</span></span><br><span class="line">		<span class="type">ClassPathXmlApplicationContext</span> <span class="variable">barContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;applicationContext.xml&quot;</span>&#125;, fooContext);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从 fooContext 中取名为 testBeanX 的 Bean，观察是否被增强</span></span><br><span class="line">		<span class="type">TestBean</span> <span class="variable">bean</span> <span class="operator">=</span> fooContext.getBean(<span class="string">&quot;testBeanX&quot;</span>, TestBean.class);</span><br><span class="line">		bean.hello();</span><br><span class="line">		log.info(<span class="string">&quot;===============&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从 barContext 中取名为 testBeanX 的 Bean，观察是否被增强</span></span><br><span class="line">		bean = barContext.getBean(<span class="string">&quot;testBeanX&quot;</span>, TestBean.class);</span><br><span class="line">		bean.hello();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从 barContext 中取父级 fooContext 中 testBeanY 的 Bean，观察是否被增强</span></span><br><span class="line">		bean = barContext.getBean(<span class="string">&quot;testBeanY&quot;</span>, TestBean.class);</span><br><span class="line">		bean.hello();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、Spring-MVC-的请求处理机制"><a href="#2、Spring-MVC-的请求处理机制" class="headerlink" title="2、Spring MVC 的请求处理机制"></a>2、Spring MVC 的请求处理机制</h3><p>Spring MVC 是三层架构：表现层、业务层和持久层，具体如下图。推荐阅读<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1649425">彻底读懂 springMVC 请求处理流程</a>。</p>
<p><img src="https://ask.qcloudimg.com/http-save/6296056/ih4rv8o45f.png?imageView2/2/w/1620" alt="Spring MVC 架构图"></p>
<h4 id="Spring-MVC-的请求处理流程"><a href="#Spring-MVC-的请求处理流程" class="headerlink" title="Spring MVC 的请求处理流程"></a>Spring MVC 的请求处理流程</h4><p>所有请求都会通过 DispatcherServlet 来执行。一个请求的大致处理流程(可以看看 DispatcherServlet 的源码，主要方法是 doService ): \</p>
<p><strong>绑定一些 Attribute</strong></p>
<ul>
<li>WebApplicationContext / LocaleResolver / Themeresolver</li>
</ul>
<p><strong>处理 Multipart</strong></p>
<ul>
<li>如果是 Multipart，则请求转为 MultipartHttpServletRequest</li>
</ul>
<p><strong>Handler 处理</strong></p>
<ul>
<li>找到对应的 Handler，执行 Controller 及前后置处理器逻辑</li>
</ul>
<p><strong>处理返回的 Model，渲染视图</strong></p>
<p>详细流程如下图。<br><img src="https://ask.qcloudimg.com/http-save/6296056/h8202u7yaw.png?imageView2/2/w/1620" alt="spring MVC 请求处理流程"></p>
<h3 id="3、定义-Controller-处理方法"><a href="#3、定义-Controller-处理方法" class="headerlink" title="3、定义 Controller 处理方法"></a>3、定义 Controller 处理方法</h3><h4 id="定义映射关系"><a href="#定义映射关系" class="headerlink" title="定义映射关系"></a>定义映射关系</h4><p>@Controller <br>@RequestMapping</p>
<ul>
<li>path / method  指定映射路径与⽅法 </li>
<li>params / headers 限定映射范围 </li>
<li>consumes / produces 限定请求与响应格式 </li>
</ul>
<p>一些快捷⽅式 </p>
<ul>
<li>@RestController  </li>
<li>@GetMapping / @PostMapping / @PutMapping / @DeleteMapping / @PatchMapping</li>
</ul>
<h4 id="定义处理方法"><a href="#定义处理方法" class="headerlink" title="定义处理方法"></a>定义处理方法</h4><ul>
<li>@RequestBody / @ResponseBody / @ResponseStatus  </li>
<li>@PathVariable / @RequestParam / @RequestHeader</li>
<li>HttpEntity / ResponseEntity </li>
</ul>
<h4 id="定义类型转换"><a href="#定义类型转换" class="headerlink" title="定义类型转换"></a>定义类型转换</h4><p>⾃己实现 WebMvcConfigurer </p>
<ul>
<li>Spring Boot 在 WebMvcAutoConfiguration 中实现了一个 </li>
<li>添加自定义的 Converter (前面有例子，可以看看)</li>
<li>添加自定义的 Formatter</li>
</ul>
<h5 id="添加自定义的-Formatter-实现类型转换"><a href="#添加自定义的-Formatter-实现类型转换" class="headerlink" title="添加自定义的 Formatter 实现类型转换"></a>添加自定义的 Formatter 实现类型转换</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springmvc.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.math.NumberUtils;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.Formatter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MoneyFormatter</span> <span class="keyword">implements</span> <span class="title class_">Formatter</span>&lt;Money&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理 CNY 10.00 / 10.00 形式的字符串</span></span><br><span class="line"><span class="comment">     * 校验不太严密，仅作演示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Money <span class="title function_">parse</span><span class="params">(String text, Locale locale)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="comment">// text 可能是是&quot;CNY 25.0&quot;或&quot;25.0&quot;,这样两种形式。</span></span><br><span class="line">        log.info(<span class="string">&quot;Json to Money, Json: &#123;&#125;, Locale: &#123;&#125;&quot;</span>, text, locale);</span><br><span class="line">        <span class="keyword">if</span> (NumberUtils.isParsable(text)) &#123; <span class="comment">// 检查字符串是否是可以转化为 number</span></span><br><span class="line">            <span class="keyword">return</span> Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), NumberUtils.createBigDecimal(text));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotEmpty(text)) &#123;</span><br><span class="line">            String[] split = StringUtils.split(text, <span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (split != <span class="literal">null</span> &amp;&amp; split.length == <span class="number">2</span> &amp;&amp; NumberUtils.isParsable(split[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="keyword">return</span> Money.of(CurrencyUnit.of(split[<span class="number">0</span>]),</span><br><span class="line">                        NumberUtils.createBigDecimal(split[<span class="number">1</span>]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParseException</span>(text, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParseException</span>(text, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">print</span><span class="params">(Money money, Locale locale)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (money == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> money.getCurrencyUnit().getCode() + <span class="string">&quot; &quot;</span> + money.getAmount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定义校"><a href="#定义校" class="headerlink" title="定义校"></a>定义校</h4><ul>
<li>通过 Validator 对绑定结果进⾏行行校验 </li>
<li>Hibernate Validator </li>
<li>@Valid 注解 </li>
<li>BindingResult  </li>
</ul>
<h4 id="Multipart-上传"><a href="#Multipart-上传" class="headerlink" title="Multipart 上传"></a>Multipart 上传</h4><ul>
<li>配置 MultipartResolver  </li>
<li>Spring Boot ⾃自动配置 MultipartAutoConfiguration </li>
<li>⽀持类型 multipart/form-data </li>
<li>MultipartFile 类型</li>
</ul>
<h4 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h4><h5 id="创建一个-NewCoffeeRequest-类。"><a href="#创建一个-NewCoffeeRequest-类。" class="headerlink" title="创建一个 NewCoffeeRequest 类。"></a>创建一个 NewCoffeeRequest 类。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springmvc.controller.reqeust;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NewCoffeeRequest</span> &#123;</span><br><span class="line">    <span class="meta">@NotEmpty</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> Money price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="具体的-Controller-方法"><a href="#具体的-Controller-方法" class="headerlink" title="具体的 Controller 方法"></a>具体的 Controller 方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springmvc.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.springmvc.controller.reqeust.NewCoffeeRequest;</span><br><span class="line"><span class="keyword">import</span> com.example.springmvc.model.Coffee;</span><br><span class="line"><span class="keyword">import</span> com.example.springmvc.service.CoffeeService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.math.NumberUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.http.fileupload.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.BindingResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/coffee&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoffeeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CoffeeService coffeeService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 表单形式，此处表单提交的值会自动注入到对应的类对象 newCoffee 中，其实完整形式是：</span></span><br><span class="line">	<span class="comment">// addCoffee(@Valid @ModelAttribute NewCoffeeRequest newCoffee, BindingResult result)，但 @ModelAttribute 可以省略。</span></span><br><span class="line">	<span class="comment">// 如果是 Json 提交，需要使用 @RequestBody 接受。</span></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/&quot;, consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">    <span class="keyword">public</span> Coffee <span class="title function_">addCoffee</span><span class="params">(<span class="meta">@Valid</span> NewCoffeeRequest newCoffee, BindingResult result)</span>&#123;   <span class="comment">//@Valid 是和 NewCoffeeRequest 类中的校验绑定的</span></span><br><span class="line">        <span class="keyword">if</span> (result.hasErrors())&#123;    <span class="comment">// @Valid 抛出的错误，绑定到 BindingResult 上</span></span><br><span class="line">            log.warn(<span class="string">&quot;Binding Errors: &#123;&#125;&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;Receive new Coffee &#123;&#125;&quot;</span>, newCoffee);</span><br><span class="line">        <span class="type">Coffee</span> <span class="variable">coffee</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">                .name(newCoffee.getName())</span><br><span class="line">                .price(newCoffee.getPrice())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> coffeeService.saveCoffee(coffee);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 批量创建多个coffee，</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;/&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Coffee&gt; <span class="title function_">batchAddCoffee</span><span class="params">(MultipartFile file)</span>&#123;</span><br><span class="line">        List&lt;Coffee&gt; coffees = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(file.getInputStream()));</span><br><span class="line">            String str;</span><br><span class="line">            <span class="keyword">while</span> ((str = reader.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">                String[] arr = StringUtils.split(str, <span class="string">&quot; &quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (arr != <span class="literal">null</span> &amp;&amp; arr.length == <span class="number">2</span>)&#123;</span><br><span class="line">                    <span class="type">Coffee</span> <span class="variable">coffee</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">                            .name(arr[<span class="number">0</span>])</span><br><span class="line">                            .price(Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), NumberUtils.createBigDecimal(arr[<span class="number">1</span>])))</span><br><span class="line">                            .build();</span><br><span class="line">                    coffees.add(coffeeService.saveCoffee(coffee));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(reader);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> coffees;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Postman-测试"><a href="#Postman-测试" class="headerlink" title="Postman 测试"></a>Postman 测试</h5><p>创建咖啡<br><img src="/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/WX20220511-094520.png"></p>
<p>批量创建咖啡</p>
<p><img src="/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/WX20220511-094749.png"></p>
<h3 id="4、Spring-MVC-中的各种机制-–-视图处理"><a href="#4、Spring-MVC-中的各种机制-–-视图处理" class="headerlink" title="4、Spring MVC 中的各种机制 – 视图处理"></a>4、Spring MVC 中的各种机制 – 视图处理</h3><h4 id="视图解析的实现基础"><a href="#视图解析的实现基础" class="headerlink" title="视图解析的实现基础"></a>视图解析的实现基础</h4><p>视图解析是基于 ViewResolver 和 View 接口实现的</p>
<ul>
<li>AbstracachingViewResolver</li>
<li>UrlBasedViewResolver</li>
<li>FreeMarkerViewResolver</li>
<li>ContentNegotiatiatingViewResolver</li>
<li>InternalResurceViewResolver</li>
</ul>
<h4 id="DispatcherServlet-中的视图解析逻辑"><a href="#DispatcherServlet-中的视图解析逻辑" class="headerlink" title="DispatcherServlet 中的视图解析逻辑"></a>DispatcherServlet 中的视图解析逻辑</h4><ul>
<li>initStrategies()<ul>
<li>initViewResolvers() 初始化了了对应 ViewResolver  </li>
</ul>
</li>
<li>doDispatch()  <ul>
<li>processDispatchResult()  <ul>
<li>没有返回视图的话，尝试 RequestToViewNameTranslator </li>
<li>resolveViewName() 解析 View 对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ResponseBody-的视图解析逻辑"><a href="#ResponseBody-的视图解析逻辑" class="headerlink" title="@ResponseBody 的视图解析逻辑"></a>@ResponseBody 的视图解析逻辑</h4><ul>
<li>在 HandlerAdapter.handle() 的中完成了 Response 输出 <ul>
<li>RequestMappingHandlerAdapter.invokeHandlerMethod()  <ul>
<li>HandlerMethodReturnValueHandlerComposite.handleReturnValue()  <ul>
<li>RequestResponseBodyMethodProcessor.handleReturnValue() </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><p>两种不同的重定向前缀 </p>
<ul>
<li>redirect:  客户端发起 302 的跳转，url会变化</li>
<li>forward:   服务端发起的，url不会变化</li>
</ul>
<h3 id="5、Spring-MVC-中的常用视图"><a href="#5、Spring-MVC-中的常用视图" class="headerlink" title="5、Spring MVC 中的常用视图"></a>5、Spring MVC 中的常用视图</h3><h4 id="Spring-Boot-对-Jackson-的支持"><a href="#Spring-Boot-对-Jackson-的支持" class="headerlink" title="Spring Boot 对 Jackson 的支持"></a>Spring Boot 对 Jackson 的支持</h4><ul>
<li>JacksonAutoConfiguration<ul>
<li>Spring Boot 通过 @JsonComponent 注册 JSON 序列化组件</li>
<li>Jackson20bjectMapperBuilderCustiomizer</li>
</ul>
</li>
<li>JacksonHttpMessageConvertersConfiguration<ul>
<li>增加 jackson-dataformat-xml 以支持 XML 序列化</li>
</ul>
</li>
</ul>
<h4 id="Spring-Boot-中关于-Jackson-的实例"><a href="#Spring-Boot-中关于-Jackson-的实例" class="headerlink" title="Spring Boot 中关于 Jackson 的实例"></a>Spring Boot 中关于 Jackson 的实例</h4><p>将 Money 类<strong>序列化</strong>为 Json 格式输入到响应中；从请求中表示 Money 对象的字符串，<strong>反序列化</strong>为Moey对象。<br>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 增加Jackson的Hibernate类型支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-hibernate5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 增加Jackson XML支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>继承 StdSerializer 实现序列化器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springmvc.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ser.std.StdSerializer;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jackson.JsonComponent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Money 序列化器，将 Money 序列化为字符串，写入文件。</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@JsonComponent</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MoneySerializer</span> <span class="keyword">extends</span> <span class="title class_">StdSerializer</span>&lt;Money&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">MoneySerializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Money.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Money money, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        jsonGenerator.writeNumber(money.getAmount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继承 StdDeserializer 实现序列化器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springmvc.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JacksonException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonParser;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.DeserializationContext;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.deser.std.StdDeserializer;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.CurrencyUnit;</span><br><span class="line"><span class="keyword">import</span> org.joda.money.Money;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jackson.JsonComponent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Money 反序列化器</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 JSON 序列化组件</span></span><br><span class="line"><span class="meta">@JsonComponent</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MoneyDeserializer</span> <span class="keyword">extends</span> <span class="title class_">StdDeserializer</span>&lt;Money&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">MoneyDeserializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Money.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Money <span class="title function_">deserialize</span><span class="params">(JsonParser jsonParser, DeserializationContext ctxt)</span> <span class="keyword">throws</span> IOException, JacksonException &#123;</span><br><span class="line">        <span class="keyword">return</span> Money.of(CurrencyUnit.of(<span class="string">&quot;CNY&quot;</span>), jsonParser.getDecimalValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注入 Hibernate5Module 模版</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 注册一个额外的Jackson模块</span></span><br><span class="line"><span class="comment">* 此处注释对程序似乎没有影响。</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="comment">// @Bean</span></span><br><span class="line"><span class="comment">// public Hibernate5Module hibernate5Module() &#123;</span></span><br><span class="line"><span class="comment">// 	return new Hibernate5Module();</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 设置 json 输出缩紧，使用 curl 请求测试。</span></span><br><span class="line"><span class="comment">* 测试方法：curl http://localhost:8080/coffee/4</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="title function_">jacksonBuilderCustomizer</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> builder -&gt;builder.indentOutput(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试方案</p>
<ul>
<li>使用 Json 格式请求创建coffee</li>
<li>使用 Form 格式请求创建coffee</li>
<li>使用 curl <a target="_blank" rel="noopener" href="http://localhost:8080/coffee/4">http://localhost:8080/coffee/4</a> 查看缩减效果</li>
<li>请求头中添加 Accept: application/xml 查看响应效果</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%206/json-view-demo">Json View demo</a></p>
<h4 id="thymeleaf-页面调用的简单例子"><a href="#thymeleaf-页面调用的简单例子" class="headerlink" title="thymeleaf 页面调用的简单例子"></a>thymeleaf 页面调用的简单例子</h4><p><a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%206/thymeleaf-view-demo">thymeleaf view demo</a></p>
<h5 id="创建一个简单的-create-order-form-html-页面"><a href="#创建一个简单的-create-order-form-html-页面" class="headerlink" title="创建一个简单的 create-order-form.html 页面"></a>创建一个简单的 create-order-form.html 页面</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Coffee Available Today<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>Coffee Name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>Price<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;coffee : $&#123;coffeeList&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;coffee.name&#125;&quot;</span>&gt;</span>Espresso<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;coffee.price&#125;&quot;</span>&gt;</span>CNY 12.0<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Your Order<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/order/&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>Customer Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;coffee : $&#123;coffeeList&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;items&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;coffee.name&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;coffee.name&#125;&quot;</span>&gt;</span>Espresso<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;message&#125;&quot;</span>&gt;</span>Message<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="调用-html-页面"><a href="#调用-html-页面" class="headerlink" title="调用 html 页面"></a>调用 html 页面</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 呈现视图：&quot;create-order-form&quot;，thymeleaf 有一些默认的配置，包括前缀和后缀，&quot;create-order-form&quot;会拼接前缀和后缀返回。</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@GetMapping(path = &quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">showCreateForm</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;create-order-form&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="form-创建订单，并且重定向"><a href="#form-创建订单，并且重定向" class="headerlink" title="form 创建订单，并且重定向"></a>form 创建订单，并且重定向</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(path = &quot;/&quot;, consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">createOrder</span><span class="params">(<span class="meta">@Valid</span> NewOrderRequest newOrder, BindingResult result, ModelMap map)</span>&#123;</span><br><span class="line">	<span class="comment">// ps: 使用@RequestBody会报错，参考： https://blog.csdn.net/qq_24089175/article/details/102568409</span></span><br><span class="line">	<span class="keyword">if</span> (result.hasErrors())&#123;</span><br><span class="line">		log.warn(<span class="string">&quot;Binding Result: &#123;&#125;&quot;</span>, result);</span><br><span class="line">		map.addAttribute(<span class="string">&quot;message&quot;</span>, result.toString());</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;create-order-form&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.info(<span class="string">&quot;Receive new Order through Form &#123;&#125;&quot;</span>, newOrder);</span><br><span class="line">	Coffee[] coffees = coffeeService.getCoffeeByName(newOrder.getItems()).toArray(<span class="keyword">new</span> <span class="title class_">Coffee</span>[]&#123;&#125;);</span><br><span class="line">	<span class="type">CoffeeOrder</span> <span class="variable">order</span> <span class="operator">=</span> orderService.createOrder(newOrder.getCustomer(), coffees);</span><br><span class="line">	<span class="comment">// 重定向</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;redirect:/order/&quot;</span> + order.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><ul>
<li>使用浏览器输入<code>http://localhost:8080/order/</code>。</li>
<li>在页面上提交订单，发现会重定向。</li>
</ul>
<h3 id="6、静态资源与缓存"><a href="#6、静态资源与缓存" class="headerlink" title="6、静态资源与缓存"></a>6、静态资源与缓存</h3><p>不建议在java程序中提供静态资源的服务，去设置缓存。一般有更合适的技术，比如 Nginx 、CMS 系统。</p>
<p><strong>建议的资源访问⽅式</strong></p>
<p><img src="/2022/04/17/%E7%8E%A9%E8%BD%ACSpring%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/WX20220514-112926.png"></p>
<h4 id="Spring-Boot-中的静态资源配置"><a href="#Spring-Boot-中的静态资源配置" class="headerlink" title="Spring Boot 中的静态资源配置"></a>Spring Boot 中的静态资源配置</h4><p>核⼼逻辑 </p>
<ul>
<li>WebMvcConfigurer.addResourceHandlers()  </li>
</ul>
<p>常⽤配置</p>
<ul>
<li>spring.mvc.static-path-pattern=/**  </li>
<li>spring.resources.static-locations=classpath:/META-INF/resources/,classpath:/resources/,classpath:/static/,classpath:/public/ </li>
</ul>
<h4 id="Spring-Boot-中的缓存配置"><a href="#Spring-Boot-中的缓存配置" class="headerlink" title="Spring Boot 中的缓存配置"></a>Spring Boot 中的缓存配置</h4><p>常⽤配置（默认时间单位都是秒） </p>
<ul>
<li>ResourceProperties.Cache</li>
<li>spring.resources.cache.cachecontrol.max-age=时间 </li>
<li>spring.resources.cache.cachecontrol.no-cache=true/false </li>
<li>spring.resources.cache.cachecontrol.s-max-age=时间</li>
</ul>
<p>代码仓库：<a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%206/cache-demo">cache demo</a></p>
<h3 id="7、Spring-MVC-中的异常处理机制"><a href="#7、Spring-MVC-中的异常处理机制" class="headerlink" title="7、Spring MVC 中的异常处理机制"></a>7、Spring MVC 中的异常处理机制</h3><h4 id="Spring-MVC-的异常解析"><a href="#Spring-MVC-的异常解析" class="headerlink" title="Spring MVC 的异常解析"></a>Spring MVC 的异常解析</h4><p>核⼼接⼝</p>
<ul>
<li>HandlerExceptionResolver </li>
</ul>
<p>实现类 </p>
<ul>
<li>SimpleMappingExceptionResolver</li>
<li>DefaultHandlerExceptionResolver  </li>
<li>ResponseStatusExceptionResolver  </li>
<li>ExceptionHandlerExceptionResolver </li>
</ul>
<h4 id="异常处理方法"><a href="#异常处理方法" class="headerlink" title="异常处理方法"></a>异常处理方法</h4><p>处理方法</p>
<ul>
<li>@ExceptionHandler </li>
</ul>
<p>添加位置</p>
<ul>
<li>@Controller / @RestController</li>
<li>@ControllerAdvice / @RestControllerAdvice </li>
</ul>
<h4 id="一个异常处理的简单例子"><a href="#一个异常处理的简单例子" class="headerlink" title="一个异常处理的简单例子"></a>一个异常处理的简单例子</h4><p>通过 throw 抛出异常，使用 @ResponseStatus 指定响应的错误码。</p>
<p>代码实例: <a target="_blank" rel="noopener" href="https://gitee.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%206/exception-demo">exception demo</a></p>
<h5 id="异常调用代码"><a href="#异常调用代码" class="headerlink" title="异常调用代码"></a>异常调用代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(path = &quot;/&quot;, consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line"><span class="keyword">public</span> Coffee <span class="title function_">addCoffee</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@ModelAttribute</span> NewCoffeeRequest newCoffee, BindingResult result)</span>&#123;   <span class="comment">//@Valid 是和 NewCoffeeRequest 类中的校验绑定的</span></span><br><span class="line">	<span class="keyword">if</span> (result.hasErrors())&#123;    <span class="comment">// @Valid 抛出的错误，绑定到 BindingResult 上</span></span><br><span class="line">		log.warn(<span class="string">&quot;Binding Errors: &#123;&#125;&quot;</span>, result);</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormValidationException</span>(result);</span><br><span class="line">	&#125;</span><br><span class="line">	log.info(<span class="string">&quot;Receive addCoffee new Coffee &#123;&#125;&quot;</span>, newCoffee);</span><br><span class="line">	<span class="type">Coffee</span> <span class="variable">coffee</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">			.name(newCoffee.getName())</span><br><span class="line">			.price(newCoffee.getPrice())</span><br><span class="line">			.build();</span><br><span class="line">	<span class="keyword">return</span> coffeeService.saveCoffee(coffee);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(path = &quot;/&quot;, consumes = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Coffee <span class="title function_">addJsonCoffee</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> NewCoffeeRequest newCoffee, BindingResult result)</span>&#123;</span><br><span class="line">	log.info(<span class="string">&quot;Receive addJsonCoffee new Coffee &#123;&#125;&quot;</span>, newCoffee);</span><br><span class="line">	<span class="keyword">if</span> (result.hasErrors())&#123;</span><br><span class="line">		log.warn(<span class="string">&quot;Binding Errors: &#123;&#125;&quot;</span>, result);</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationException</span>(result.toString());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">Coffee</span> <span class="variable">coffee</span> <span class="operator">=</span> Coffee.builder()</span><br><span class="line">			.name(newCoffee.getName())</span><br><span class="line">			.price(newCoffee.getPrice())</span><br><span class="line">			.build();</span><br><span class="line">	<span class="keyword">return</span> coffeeService.saveCoffee(coffee);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="异常处理类"><a href="#异常处理类" class="headerlink" title="异常处理类"></a>异常处理类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springmvc.controller.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.BindingResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormValidationException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BindingResult result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h5><ul>
<li>使用postman 发送 post（<code>http://localhost:8080/coffee/</code>） 请求，使用 form 指定 name ，不指定 price 。</li>
<li>使用postman 发送 post（<code>http://localhost:8080/coffee/</code>） 请求，使用 json 不指定 name ，指定 price 。</li>
</ul>
<h3 id="8、Spring-MVC-的拦截器器"><a href="#8、Spring-MVC-的拦截器器" class="headerlink" title="8、Spring MVC 的拦截器器"></a>8、Spring MVC 的拦截器器</h3><h4 id="核⼼接⼝"><a href="#核⼼接⼝" class="headerlink" title="核⼼接⼝"></a>核⼼接⼝</h4><ul>
<li>HandlerInteceptor<ul>
<li>boolean preHandle()  </li>
<li>void postHandle()  </li>
<li>void afterCompletion() </li>
</ul>
</li>
</ul>
<h4 id="针对-ResponseBody-和-ResponseEntity-的情况"><a href="#针对-ResponseBody-和-ResponseEntity-的情况" class="headerlink" title="针对 @ResponseBody 和 ResponseEntity 的情况"></a>针对 @ResponseBody 和 ResponseEntity 的情况</h4><ul>
<li>ResponseBodyAdvice  </li>
</ul>
<h4 id="针对异步请求的接⼝"><a href="#针对异步请求的接⼝" class="headerlink" title="针对异步请求的接⼝"></a>针对异步请求的接⼝</h4><ul>
<li>AsyncHandlerInterceptor  </li>
<li>void afterConcurrentHandlingStarted()</li>
</ul>
<p>异步的时候不会自动执行 postHandle() 、Completion 等方法的。</p>
<h4 id="拦截器的配置⽅式"><a href="#拦截器的配置⽅式" class="headerlink" title="拦截器的配置⽅式"></a>拦截器的配置⽅式</h4><p>常规方法 </p>
<ul>
<li>WebMvcConfigurer.addInterceptors()</li>
</ul>
<p>Spring Boot 中的配置 </p>
<ul>
<li>创建⼀个带 @Configuration 的 WebMvcConfigurer 配置类 </li>
<li>不能带 @EnableWebMvc（想彻底⾃己控制 MVC 配置除外）</li>
</ul>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p><a target="_blank" rel="noopener" href="https://jiaoqiang2014.github.io/2022/04/15/SpringMVC%E5%AE%9E%E7%8E%B0%E6%8B%A6%E6%88%AA%E5%99%A8-1/">SpringMVC实现拦截器-1</a></p>
<p><a target="_blank" rel="noopener" href="https://jiaoqiang2014.github.io/2022/06/08/SpringMVC%E5%AE%9E%E7%8E%B0%E6%8B%A6%E6%88%AA%E5%99%A8-2/">SpringMVC实现拦截器_2</a></p>
<h2 id="第七章-访问-Web-资源"><a href="#第七章-访问-Web-资源" class="headerlink" title="第七章 访问 Web 资源"></a>第七章 访问 Web 资源</h2><h3 id="通过-RestTemplate-访问-Web-资源"><a href="#通过-RestTemplate-访问-Web-资源" class="headerlink" title="通过 RestTemplate 访问 Web 资源"></a>通过 RestTemplate 访问 Web 资源</h3><ul>
<li>Spring Boot 中没有自动配置 RestTemplate</li>
<li>Spring Boot 提供了 RestTemplateBuilder<ul>
<li>RestTemplateBuilder.build()</li>
</ul>
</li>
</ul>
<h4 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h4><p>GET 请求</p>
<ul>
<li>getForObject() / getForEntity()</li>
</ul>
<p>POST 请求</p>
<ul>
<li>postForObject() / postForEntity()</li>
</ul>
<p>PUT 请求</p>
<ul>
<li>put()</li>
</ul>
<p>DELETE 请求</p>
<ul>
<li>delete()</li>
</ul>
<h4 id="构造-URI"><a href="#构造-URI" class="headerlink" title="构造 URI"></a>构造 URI</h4><p>构造 URI</p>
<ul>
<li>UriComponentsBuilder</li>
</ul>
<p>构造相对于当前请求的 URI</p>
<ul>
<li>ServletUriComponentsBuilder</li>
</ul>
<p>构造 Controller 的 URI</p>
<ul>
<li>MvcUriComponentBuilder</li>
</ul>
<h3 id="RestTemplate-的高阶用法"><a href="#RestTemplate-的高阶用法" class="headerlink" title="RestTemplate 的高阶用法"></a>RestTemplate 的高阶用法</h3><h3 id="简单定制-RestTemplate"><a href="#简单定制-RestTemplate" class="headerlink" title="简单定制 RestTemplate"></a>简单定制 RestTemplate</h3><h3 id="通过-WebClient-访问-Web-资源"><a href="#通过-WebClient-访问-Web-资源" class="headerlink" title="通过 WebClient 访问 Web 资源"></a>通过 WebClient 访问 Web 资源</h3><h4 id="了解-WebClient"><a href="#了解-WebClient" class="headerlink" title="了解 WebClient"></a>了解 WebClient</h4><p>WebClient 是一个以 Reactive 方式处理 HTTP 请求的非阻塞式的客户端。</p>
<p><strong>支持的底层 HTTP 库</strong></p>
<ul>
<li>Reactor Netty - ReactorClientHttpConnector</li>
<li>Jetty ReactiveStream HttpClient - JettyClientHttpConnector</li>
</ul>
<p><strong>创建 WebClient</strong></p>
<ul>
<li>WebClient.create()</li>
<li>WebClient.builder()</li>
</ul>
<p><strong>发起请求</strong></p>
<ul>
<li>get() / post() / put() / delete() / patch()</li>
</ul>
<p><strong>获得结果</strong></p>
<ul>
<li>retrieve() / exchange()</li>
</ul>
<p><strong>处理 HTTP Status</strong></p>
<ul>
<li>onStatus()</li>
</ul>
<p><strong>应答正文</strong></p>
<ul>
<li>bodyToMono() / bodyToFlux()</li>
</ul>
<h2 id="第八章-Web-开发进阶"><a href="#第八章-Web-开发进阶" class="headerlink" title="第八章 Web 开发进阶"></a>第八章 Web 开发进阶</h2><h3 id="设计好的-RESTful-Web-Service"><a href="#设计好的-RESTful-Web-Service" class="headerlink" title="设计好的 RESTful Web Service"></a>设计好的 RESTful Web Service</h3><p>“REST 提供了一组架构约束，当作为一个整体来应用时，强调组件交互的可伸缩性、接口的通⽤性、组件的独⽴部署、以及用来减少交互延迟、增强安全性、封装遗留系统的中间组件。” - Roy Thomas Fielding</p>
<h3 id="认识-HTTP-⽅方法"><a href="#认识-HTTP-⽅方法" class="headerlink" title="认识 HTTP ⽅方法"></a>认识 HTTP ⽅方法</h3><p>安全是指不改变资源，幂等是指多次请求产生的效果一样。</p>
<table>
<thead>
<tr>
<th>动作</th>
<th>安全 / 幂等</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>Y / Y</td>
<td>信息获取</td>
</tr>
<tr>
<td>POST</td>
<td>N / N</td>
<td>该⽅法⽤途广泛，可⽤用于创建、更新或一次性对多个资源进⾏修改</td>
</tr>
<tr>
<td>DELETE</td>
<td>N / Y</td>
<td>删除资源</td>
</tr>
<tr>
<td>PUT</td>
<td>N / Y</td>
<td>更新或者完全替换⼀个资源</td>
</tr>
<tr>
<td>HEAD</td>
<td>Y / Y</td>
<td>获取与 GET ⼀样的 HTTP 头信息，但没有响应体</td>
</tr>
<tr>
<td>OPTIONS</td>
<td>Y / Y</td>
<td>获取资源支持的 HTTP 方法列表</td>
</tr>
<tr>
<td>TRACE</td>
<td>Y / Y</td>
<td>让服务器返回其收到的 HTTP 头</td>
</tr>
</tbody></table>
<h3 id="HATEOAS"><a href="#HATEOAS" class="headerlink" title="HATEOAS"></a>HATEOAS</h3><h3 id="使用-Spring-Data-REST-实现简单的超媒体服务"><a href="#使用-Spring-Data-REST-实现简单的超媒体服务" class="headerlink" title="使用 Spring Data REST 实现简单的超媒体服务"></a>使用 Spring Data REST 实现简单的超媒体服务</h3><h4 id="认识-HAL"><a href="#认识-HAL" class="headerlink" title="认识 HAL"></a>认识 HAL</h4><ul>
<li>Hypertext Application Language<br>HAL 是一种简单的格式，为 API 中的资源提供简单一致的链接 </li>
</ul>
<h4 id="HAL-模型"><a href="#HAL-模型" class="headerlink" title="HAL 模型"></a>HAL 模型</h4><ul>
<li>链接 </li>
<li>内嵌资源 </li>
<li>状态</li>
</ul>
<h3 id="Spring-Data-REST"><a href="#Spring-Data-REST" class="headerlink" title="Spring Data REST"></a>Spring Data REST</h3><p>Spring Boot 依赖 </p>
<ul>
<li>spring-boot-starter-data-rest</li>
</ul>
<p>常用注解与类 </p>
<ul>
<li>@RepositoryRestResource  </li>
<li>Resource<T>  </T></li>
<li>PagedResource<T> </T></li>
</ul>
<h3 id="如何访问-HATEOAS-服务"><a href="#如何访问-HATEOAS-服务" class="headerlink" title="如何访问 HATEOAS 服务"></a>如何访问 HATEOAS 服务</h3><p>配置 Jackson JSON </p>
<ul>
<li>注册 HAL ⽀支持 </li>
</ul>
<p>操作超链接 </p>
<ul>
<li>找到需要的 Link </li>
<li>访问超链接</li>
</ul>
<h3 id="分布式环境中如何解决-Session-的问题"><a href="#分布式环境中如何解决-Session-的问题" class="headerlink" title="分布式环境中如何解决 Session 的问题"></a>分布式环境中如何解决 Session 的问题</h3><ul>
<li>粘性会话 Sticky Session </li>
<li>会话复制 Session Replication </li>
<li>集中会话 Centralized Session</li>
</ul>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p>定制 HttpSession </p>
<ul>
<li>通过定制的 HttpServletRequest 返回定制的 HttpSession </li>
<li>SessionRepositoryRequestWrapper  </li>
<li>SessionRepositoryFilter  </li>
<li>DelegatingFilterProxy </li>
</ul>
<h4 id="基于-Redis-的-HttpSession"><a href="#基于-Redis-的-HttpSession" class="headerlink" title="基于 Redis 的 HttpSession"></a>基于 Redis 的 HttpSession</h4><p>引⼊依赖 </p>
<ul>
<li>spring-session-data-redis </li>
</ul>
<p>基本配置 </p>
<ul>
<li>@EnableRedisHttpSession  </li>
<li>提供 RedisConnectionFactory </li>
<li>实现 AbstractHttpSessionApplicationInitializer  <ul>
<li>配置 DelegatingFilterProxy</li>
</ul>
</li>
</ul>
<h4 id="Spring-Boot-对-Spring-Session-的⽀持"><a href="#Spring-Boot-对-Spring-Session-的⽀持" class="headerlink" title="Spring Boot 对 Spring Session 的⽀持"></a>Spring Boot 对 Spring Session 的⽀持</h4><p>application.properties </p>
<ul>
<li>spring.session.store-type=redis  <ul>
<li>spring.session.timeout=  </li>
</ul>
</li>
<li>server.servlet.session.timeout=  </li>
<li>spring.session.redis.flush-mode=on-save  </li>
<li>spring.session.redis.namespace=spring:session </li>
</ul>
<h3 id="使用-WebFlux-代替-Spring-MVC"><a href="#使用-WebFlux-代替-Spring-MVC" class="headerlink" title="使用 WebFlux 代替 Spring MVC"></a>使用 WebFlux 代替 Spring MVC</h3><h4 id="认识-WebFlux"><a href="#认识-WebFlux" class="headerlink" title="认识 WebFlux"></a>认识 WebFlux</h4><p>什么是 WebFlux </p>
<ul>
<li>用于构建基于 Reactive 技术栈之上的 Web 应用程序 </li>
<li>基于 Reactive Streams API ，运行在非阻塞服务器上 </li>
</ul>
<p>为什么会有 WebFlux </p>
<ul>
<li>对于⾮阻塞 Web 应⽤的需要 </li>
<li>函数式编程</li>
</ul>
<p>关于 WebFlux 的性能 </p>
<ul>
<li>请求的耗时并不不会有很大的改善 </li>
<li>仅需少量固定数量的线程和较少的内存即可实现扩展 </li>
</ul>
<h4 id="WebMVC-v-s-WebFlux"><a href="#WebMVC-v-s-WebFlux" class="headerlink" title="WebMVC v.s. WebFlux"></a>WebMVC v.s. WebFlux</h4><ul>
<li>已有 Spring MVC 应用，运行正常，就别改了</li>
<li>依赖了⼤量阻塞式持久化 API 和⽹络 API，建议使用 Spring MVC </li>
<li>已经使用了非阻塞技术栈，可以考虑使用 WebFlux </li>
<li>想要使用 Java 8 Lambda 结合轻量级函数式框架，可以考虑 WebFlux</li>
</ul>
<h4 id="WebFlux-中的编程模型"><a href="#WebFlux-中的编程模型" class="headerlink" title="WebFlux 中的编程模型"></a>WebFlux 中的编程模型</h4><ul>
<li>基于注解的控制器</li>
<li>函数式 Endpoints </li>
</ul>
<h4 id="基于注解的控制器器"><a href="#基于注解的控制器器" class="headerlink" title="基于注解的控制器器"></a>基于注解的控制器器</h4><p>常用注解 </p>
<ul>
<li>@Controller  </li>
<li>@RequestMapping 及其等价注解 </li>
<li>@RequestBody / @ResponseBody</li>
</ul>
<p>返回值 </p>
<ul>
<li>Mono<T> / Flux<T> </T></T></li>
</ul>
<h2 id="第九章-重新认识-Spring-Boot"><a href="#第九章-重新认识-Spring-Boot" class="headerlink" title="第九章 重新认识 Spring Boot"></a>第九章 重新认识 Spring Boot</h2><p>Spring Boot 四大核心</p>
<ul>
<li>自动配置 - Auto Configuration</li>
<li>起步依赖 - Starter Dependency</li>
<li>命令行界面 - Spring Boot CLI</li>
<li>Actuator</li>
</ul>
<h3 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h3><ul>
<li>基于添加的 JAR 依赖⾃动对 Spring Boot 应⽤程序进⾏配置</li>
<li>自动配置都在类 spring-boot-autoconﬁguration 中</li>
</ul>
<p>开启⾃动配置</p>
<ul>
<li>@EnableAutoConfiguration <ul>
<li>exclude = Class&lt;?&gt;[] </li>
</ul>
</li>
<li>@SpringBootApplication</li>
</ul>
<p>@SpringBootApplication 注解中包含了 @EnableAutoConﬁguration</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7046554366068654094#heading-17">一文搞懂🔥SpringBoot自动配置原理</a></p>
<h3 id="⾃动配置的实现原理"><a href="#⾃动配置的实现原理" class="headerlink" title="⾃动配置的实现原理"></a>⾃动配置的实现原理</h3><p>@EnableAutoConﬁguration</p>
<ul>
<li>AutoConfigurationImportSelector</li>
<li>META-INF/spring.factories<ul>
<li>org.springframework.boot.autoconfigure.EnableAutoConfiguration</li>
</ul>
</li>
</ul>
<p>条件注解</p>
<ul>
<li>@Conditional</li>
<li>@ConditionalOnClass</li>
<li>@ConditionalOnBean</li>
<li>@ConditionalOnMissingBean</li>
<li>@ConditionalOnProperty</li>
<li>……</li>
</ul>
<h3 id="观察⾃动配置的判断结果"><a href="#观察⾃动配置的判断结果" class="headerlink" title="观察⾃动配置的判断结果"></a>观察⾃动配置的判断结果</h3><ul>
<li>–debug</li>
</ul>
<p>这个结果是通过 ConditionEvaluationReportLoggingListener 输出的。</p>
<h4 id="ConditionEvaluationReportLoggingListener"><a href="#ConditionEvaluationReportLoggingListener" class="headerlink" title="ConditionEvaluationReportLoggingListener"></a>ConditionEvaluationReportLoggingListener</h4><ul>
<li>Positive matches</li>
<li>Negative matches</li>
<li>Exclusions</li>
<li>Unconditional classes</li>
</ul>
<h3 id="动⼿实现⾃⼰的⾃动配置"><a href="#动⼿实现⾃⼰的⾃动配置" class="headerlink" title="动⼿实现⾃⼰的⾃动配置"></a>动⼿实现⾃⼰的⾃动配置</h3><p>1、编写 Java Conﬁg</p>
<ul>
<li>@Configuration</li>
</ul>
<p>2、添加条件</p>
<ul>
<li>@Conditional</li>
</ul>
<p>3、定位⾃动配置</p>
<ul>
<li>META-INF/spring.factories</li>
</ul>
<h4 id="条件注解⼤家庭"><a href="#条件注解⼤家庭" class="headerlink" title="条件注解⼤家庭"></a>条件注解⼤家庭</h4><p><strong>条件注解</strong></p>
<ul>
<li>@Conditional</li>
</ul>
<p><strong>类条件</strong></p>
<ul>
<li>@ConditionalOnClass</li>
</ul>
<p>当存在一个类时会做什么</p>
<ul>
<li>@ConditionalOnMissingClass</li>
</ul>
<p>当不存在一个类时会做什么</p>
<p><strong>属性条件</strong></p>
<ul>
<li>@ConditionalOnProperty</li>
</ul>
<p>可以使用@ConditionalOnProperty注解来控制@Configuration是否生效.</p>
<p>通过其两个属性name以及havingValue来实现的，其中name用来从application.properties中读取某个属性值。<br>如果该值为空，则返回false;<br>如果值不为空，则将该值与havingValue指定的值进行比较，如果一样则返回true;否则返回false。<br>如果返回值为false，则该configuration不生效；为true则生效。<br><strong>Bean 条件</strong></p>
<ul>
<li>@ConditionalOnBean</li>
</ul>
<p>存在某个 Bean 时做什么。</p>
<ul>
<li>@ConditionalOnMissingBean</li>
</ul>
<p>存在某个 Bean 时做什么。</p>
<ul>
<li>@ConditionalOnSingleCandidate</li>
</ul>
<p>上下文中存在一个 Bean 是做什么。</p>
<p><strong>资源条件</strong></p>
<ul>
<li>@ConditionalOnResource</li>
</ul>
<p><strong>Web 应⽤条件</strong></p>
<ul>
<li>@ConditionalOnWebApplication</li>
<li>@ConditionalOnNotWebApplication</li>
</ul>
<p><strong>其他条件</strong></p>
<ul>
<li>@ConditionalOnExpression</li>
<li>@ConditionalOnJava</li>
<li>@ConditionalOnJndi</li>
</ul>
<h4 id="⾃动配置的执⾏顺序"><a href="#⾃动配置的执⾏顺序" class="headerlink" title="⾃动配置的执⾏顺序"></a>⾃动配置的执⾏顺序</h4><ul>
<li>@AutoConfigureBefore</li>
</ul>
<p>指定该自动配置类在某些配置执行之前执行。</p>
<ul>
<li>@AutoConfigureAfter</li>
</ul>
<p>指定该自动配置类在某些配置执行之后执行。</p>
<ul>
<li>@AutoConfigureOrder</li>
</ul>
<p>指定该自动配置类的执行顺序。</p>
<h4 id="动⼿实现⾃⼰的⾃动配置代码"><a href="#动⼿实现⾃⼰的⾃动配置代码" class="headerlink" title="动⼿实现⾃⼰的⾃动配置代码"></a>动⼿实现⾃⼰的⾃动配置代码</h4><p><a target="_blank" rel="noopener" href="https://github.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%209">代码</a></p>
<p>在类 autoconfigure-demo 启动时，自动实现 geektime 的自动配置。</p>
<p>首先创建一个主工程 autoconfigure-demo，完成对它的自动配置。创建两个模块 geektime 和 geektime-spring-boot-autoconfigure ，通过 geektime-spring-boot-autoconfigure 实现对 geektime 的自动配置。</p>
<p><strong>在 autoconfigure-demo 的 pom 中引入 对 geektime-spring-boot-autoconfigure 和 geektime 的依赖</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>geektime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.geektimeAutoconfigure<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>geektime-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>在 geektime 中写一些简单的代码，代表需要自动配置的内容</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geektime;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreetingApplicationRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">GreetingApplicationRunner</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>(<span class="string">&quot;Greeting&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">GreetingApplicationRunner</span><span class="params">(String name)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.name = name;</span><br><span class="line">		log.info(<span class="string">&quot;Initializing GreetingApplicationRunner for &#123;&#125;.&quot;</span>, name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		log.info(<span class="string">&quot;Hello everyone! We all like Spring!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现真正的自动配置类</strong> <br>首先，引入对 geektime 的依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;geektime&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>然后，在 META-INF/spring.factories 中将 eektime-spring-boot-autoconfigure 添加进去。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">com.geektimeAutoconfigure.GreetingAutoConfiguration</span></span><br></pre></td></tr></table></figure>

<p>接下来，实现具体的自动配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geektimeAutoconfigure;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 只用当 classPath 中存在 GreetingApplicationRunner.class 的时候才会生效。</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(GreetingApplicationRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreetingAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line"><span class="comment">//     在GreetingApplicationRunner 上下文不存在这样一个Bean的时候才会继续下面操作。</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(GreetingApplicationRunner.class)</span></span><br><span class="line">    <span class="comment">// 判断 greeting.enabled 的属性，当值为 true 时才会生效，matchIfMissing = true 表示当 greeting.enabled 没有配置时，默认值也为 true。</span></span><br><span class="line">	<span class="comment">// greeting.enabled 可以在配置文件中添加：greeting.enabled=true。注意是 autoconfigure-demo 中的配置文件。</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;greeting.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line">    <span class="keyword">public</span> GreetingApplicationRunner <span class="title function_">GreetingAutoConfiguration</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;new a GreetingApplicationRunner&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GreetingApplicationRunner</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c.e.a.AutoconfigureDemoApplication       : No active profile <span class="built_in">set</span>, falling back to 1 default profile: <span class="string">&quot;default&quot;</span></span><br><span class="line">c.g.GreetingAutoConfiguration            : new a GreetingApplicationRunner</span><br><span class="line">com.geektime.GreetingApplicationRunner   : Initializing GreetingApplicationRunner <span class="keyword">for</span> Greeting.</span><br><span class="line">c.e.a.AutoconfigureDemoApplication       : Started AutoconfigureDemoApplication <span class="keyword">in</span> 1.562 seconds (JVM running <span class="keyword">for</span> 2.176)</span><br><span class="line">com.geektime.GreetingApplicationRunner   : Hello everyone! We all like Spring!</span><br></pre></td></tr></table></figure>

<p>可以看出“Initializing GreetingApplicationRunner for Greeting.” 实现了对 “Hello everyone! We all like Spring!” 的自动配置。</p>
<p><strong>结论</strong> <br>从上面的代码可以总结，spring Boot 的自动配置是通过基于条件注解的逻辑实现，需要注意的是 条件注解是在Spring 4 中引进的。</p>
<h3 id="如何在低版本-Spring-中快速实现类似自动配置的功能"><a href="#如何在低版本-Spring-中快速实现类似自动配置的功能" class="headerlink" title="如何在低版本 Spring 中快速实现类似自动配置的功能"></a>如何在低版本 Spring 中快速实现类似自动配置的功能</h3><h4 id="需求与问题"><a href="#需求与问题" class="headerlink" title="需求与问题"></a>需求与问题</h4><p>核⼼的诉求</p>
<ul>
<li>现存系统，不打算重构</li>
<li>Spring 版本3.x，不打算升级版本和引⼊ Spring Boot</li>
<li>期望能够在少改代码的前提下实现⼀些功能增强</li>
</ul>
<p>⾯临的问题</p>
<ul>
<li>3.x 的 Spring 没有条件注解</li>
<li>⽆法⾃动定位需要加载的⾃动配置</li>
</ul>
<h4 id="核⼼解决思路"><a href="#核⼼解决思路" class="headerlink" title="核⼼解决思路"></a>核⼼解决思路</h4><p>需要解决的问题一：条件判断</p>
<ul>
<li>通过 BeanFactoryPostProcessor 进⾏判断</li>
</ul>
<p>需要解决的问题二：配置加载</p>
<ul>
<li>编写 Java Conﬁg 类</li>
<li>引⼊配置类<ul>
<li>通过 component-scan</li>
<li>通过 XML ⽂件 import</li>
</ul>
</li>
</ul>
<h4 id="Spring-的两个扩展点"><a href="#Spring-的两个扩展点" class="headerlink" title="Spring 的两个扩展点"></a>Spring 的两个扩展点</h4><p>BeanPostProcessor</p>
<ul>
<li>针对 Bean 实例</li>
<li>在 Bean 创建后提供定制逻辑回调</li>
</ul>
<p>BeanFactoryPostProcessor</p>
<ul>
<li>针对 Bean 定义</li>
<li>在容器创建 Bean 前获取配置元数据</li>
<li>Java Conﬁg 中需要定义为 static ⽅法</li>
</ul>
<p>关于 Bean 的⼀些定制</p>
<p>Lifecycle Callback</p>
<ul>
<li>InitializingBean / @PostConstruct / init-method </li>
<li>DisposableBean / @PreDestroy / destroy-method </li>
</ul>
<p>XxxAware 接⼝</p>
<ul>
<li>ApplicationContextAware</li>
<li>BeanFactoryAware</li>
<li>BeanNameAware</li>
</ul>
<h4 id="⼀些常⽤操作"><a href="#⼀些常⽤操作" class="headerlink" title="⼀些常⽤操作"></a>⼀些常⽤操作</h4><p>判断类是否存在</p>
<ul>
<li>ClassUtils.isPresent() </li>
</ul>
<p>判断 Bean 是否已定义</p>
<ul>
<li>ListableBeanFactory.containsBeanDefinition()</li>
<li>ListableBeanFactory.getBeanNamesForType()</li>
</ul>
<p>注册 Bean 定义</p>
<ul>
<li>BeanDefinitionRegistry.registerBeanDefinition()<ul>
<li>GenericBeanDefinition</li>
</ul>
</li>
<li>BeanFactory.registerSingleton()</li>
</ul>
<h4 id="低版本-Spring-中快速实现类似自动配置功能代码"><a href="#低版本-Spring-中快速实现类似自动配置功能代码" class="headerlink" title="低版本 Spring 中快速实现类似自动配置功能代码"></a>低版本 Spring 中快速实现类似自动配置功能代码</h4><p><a target="_blank" rel="noopener" href="https://github.com/geektime-geekbang/geektime-spring-family/tree/master/Chapter%209">代码</a></p>
<p>在类 autoconfigure-demo 启动时，自动实现 geektime 的自动配置。</p>
<p>首先创建一个主工程 autoconfigure-demo，完成对它的自动配置。创建两个模块 geektime 和 geektime-autoconfigure-backport ，通过 geektime-autoconfigure-backport 实现对 geektime 的自动配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="了解起步依赖及其实现原理"><a href="#了解起步依赖及其实现原理" class="headerlink" title="了解起步依赖及其实现原理"></a>了解起步依赖及其实现原理</h3><h4 id="关于-Maven-依赖管理的一些⼩技巧"><a href="#关于-Maven-依赖管理的一些⼩技巧" class="headerlink" title="关于 Maven 依赖管理的一些⼩技巧"></a>关于 Maven 依赖管理的一些⼩技巧</h4><p>了解你的依赖 </p>
<ul>
<li>mvn dependency:tree  </li>
<li>IDEA Maven Helper 插件</li>
</ul>
<p>排除特定依赖 </p>
<ul>
<li>exclusion</li>
</ul>
<p>统一管理依赖 </p>
<ul>
<li>dependencyManagement  </li>
<li>Bill of Materials - bom</li>
</ul>
<h4 id="Spring-Boot-的起步依赖"><a href="#Spring-Boot-的起步依赖" class="headerlink" title="Spring Boot 的起步依赖"></a>Spring Boot 的起步依赖</h4><p>Starter Dependencies </p>
<ul>
<li>直接面向功能 </li>
<li>一站获得所有相关依赖，不再复制粘贴 </li>
</ul>
<p>官方的 Starters </p>
<ul>
<li>spring-boot-starter-* </li>
</ul>
<h4 id="定制⾃己的起步依赖"><a href="#定制⾃己的起步依赖" class="headerlink" title="定制⾃己的起步依赖"></a>定制⾃己的起步依赖</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SpringMVC/" rel="tag"># SpringMVC</a>
              <a href="/tags/SpringBoot/" rel="tag"># SpringBoot</a>
              <a href="/tags/Spring/" rel="tag"># Spring</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/16/%E5%88%9D%E8%AF%86ThreadLocal/" rel="prev" title="初识ThreadLocal">
      <i class="fa fa-chevron-left"></i> 初识ThreadLocal
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/18/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E6%9D%82%E9%A1%B9/" rel="next" title="开发环境安装杂项">
      开发环境安装杂项 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-JDBC%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A"><span class="nav-text">第二章 JDBC必知必会</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AE%E5%8D%95%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-text">1、配置单个数据源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-text">2、配置多个数据源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E6%8E%A8%E8%8D%90"><span class="nav-text">3、数据库连接池推荐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81JdbcTemplate-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">4、JdbcTemplate 的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81NamedParameterJdbcTemplate"><span class="nav-text">5、NamedParameterJdbcTemplate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E3%80%81%E4%BA%8B%E5%8A%A1"><span class="nav-text">6、事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">编程式事务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">声明式事务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%BC%A0%E6%92%AD%E7%89%B9%E6%80%A7"><span class="nav-text">事务的传播特性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%E3%80%81%E6%85%A2-SQL-%E6%97%A5%E5%BF%97"><span class="nav-text">7、慢 SQL 日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-O-R-Mapping-%E5%AE%9E%E8%B7%B5"><span class="nav-text">第三章 O&#x2F;R Mapping 实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81Spring-Data-JPA"><span class="nav-text">1、Spring Data JPA</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Data-JPA-%E6%8F%90%E4%BE%9B%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-text">Spring Data JPA 提供的支持</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8-Spring-Data-JPA-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">2、使用 Spring Data JPA 操作数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%EF%BC%88%E8%A1%A8%EF%BC%89"><span class="nav-text">创建实体（表）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="nav-text">实现 操作数据库的接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-text">测试代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81MyBatis-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">3、MyBatis 操作数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F"><span class="nav-text">注解方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XML-%E6%96%B9%E5%BC%8F"><span class="nav-text">XML 方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81MaBatis-Generator"><span class="nav-text">4、MaBatis Generator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81MaBatis-PageHelper"><span class="nav-text">5、MaBatis PageHelper</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-NoSQL-%E5%AE%9E%E8%B7%B5"><span class="nav-text">第四章 NoSQL 实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81docker-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="nav-text">1、docker 的一些环境安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81MongoDB"><span class="nav-text">2、MongoDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81Spring-%E4%B8%AD%E8%AE%BF%E9%97%AE-MongoDB"><span class="nav-text">3、Spring 中访问 MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E5%AE%89%E8%A3%85-MongoDB"><span class="nav-text">3.1 安装 MongoDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E5%9F%BA%E4%BA%8E-MongoTemplate-%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">3.2 基于 MongoTemplate 的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Coffee-%E7%B1%BB"><span class="nav-text">创建 Coffee 类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-MongoDB"><span class="nav-text">配置 MongoDB</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B-Money-%E7%9A%84%E8%BD%AC%E5%8C%96%E4%BB%A3%E7%A0%81%EF%BC%88-Mongo-gt-Money-%E7%B1%BB%E5%9E%8B%EF%BC%89"><span class="nav-text">编写特殊类型 Money 的转化代码（ Mongo -&gt; Money 类型）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E4%BB%A3%E7%A0%81"><span class="nav-text">调用代码</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E5%9F%BA%E4%BA%8E-Spring-Data-MongoDB-%E7%9A%84-Repository-%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">3.3 基于 Spring Data MongoDB 的 Repository 的方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81Redis"><span class="nav-text">4、Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Jedis-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93"><span class="nav-text">Jedis 客户端的简单使用-代码仓库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-%E7%9A%84%E4%B8%A4%E7%A7%8D%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F"><span class="nav-text">Redis 的两种部署方式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="nav-text">哨兵模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81Spring-Boot-%E7%BC%93%E5%AD%98%E6%8A%BD%E8%B1%A1"><span class="nav-text">5、Spring Boot 缓存抽象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-boot-%E4%B8%BA%E4%B8%8D%E5%90%8C%E7%9A%84%E7%BC%93%E5%AD%98%E6%8F%90%E4%BE%9B%E4%B8%80%E5%B1%82%E6%8A%BD%E8%B1%A1"><span class="nav-text">Spring boot 为不同的缓存提供一层抽象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-boot-%E9%BB%98%E8%AE%A4%E7%BC%93%E5%AD%98%EF%BC%88%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%EF%BC%89-%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93"><span class="nav-text">Spring boot 默认缓存（本地缓存） - 代码仓库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E6%88%90-redis-%E7%BC%93%E5%AD%98"><span class="nav-text">集成 redis 缓存</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E3%80%81Redis-%E5%9C%A8-Spring-%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E7%94%A8%E6%B3%95"><span class="nav-text">6、Redis 在 Spring 中的其他用法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8E-Redis-%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="nav-text">与 Redis 建立连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-text">读写分离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RedisTemplate"><span class="nav-text">RedisTemplate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-Repository"><span class="nav-text">Redis Repository</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%BA%E4%BA%86%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%EF%BC%88JPA%E3%80%81Mongn%E3%80%81Redis%EF%BC%89%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84-Repository"><span class="nav-text">出了不同类型（JPA、Mongn、Redis）数据源的 Repository</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-Repository-%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E4%BE%8B"><span class="nav-text">Redis Repository 的简单实例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E8%BF%9B%E9%98%B6"><span class="nav-text">第五章 数据访问进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81Project-Reactor-%E4%BB%8B%E7%BB%8D"><span class="nav-text">1、Project Reactor 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">一些核心概念</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81Reactor-%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE-Redis"><span class="nav-text">2、Reactor 方式访问 Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Data-Redis-%E4%B8%AD%E5%AF%B9-Reactive-%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-text">Spring Data Redis 中对 Reactive 的支持</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E9%80%9A%E8%BF%87-Reactor-%E8%83%BD%E5%8A%9B%E8%AE%BF%E9%97%AE-Redis-%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-text">一个简单的通过 Reactor 能力访问 Redis 的例子</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81Reactive-%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE-MongoDB"><span class="nav-text">3、Reactive 方式访问 MongoDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81Reactive-%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE-RDBMS"><span class="nav-text">4、Reactive 方式访问 RDBMS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Data-R2DBC"><span class="nav-text">Spring Data R2DBC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#R2DBC-Repository-%E2%BD%80%E6%94%AF%E6%8C%81"><span class="nav-text">R2DBC Repository ⽀支持</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81%E9%80%9A%E8%BF%87-AOP-%E6%89%93%E5%8D%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%E6%91%98%E8%A6%81"><span class="nav-text">5、通过 AOP 打印数据访问层摘要</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP-%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8B"><span class="nav-text">AOP (面向切面编程)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-AOP-%E7%9A%84%E2%BC%80%E4%BA%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">Spring AOP 的⼀些核心概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="nav-text">常用注解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP-%E6%B5%81%E7%A8%8B"><span class="nav-text">AOP 流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90"><span class="nav-text">性能拦截器的简单例子</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PS%EF%BC%9A%E5%A6%82%E4%BD%95%E6%89%93%E5%8D%B0SQL"><span class="nav-text">PS：如何打印SQL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-text">导入依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-p6spy"><span class="nav-text">配置 p6spy</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA-psy-properties-%E6%B7%BB%E5%8A%A0-p6spy-%E9%85%8D%E7%BD%AE"><span class="nav-text">新建 psy.properties 添加 p6spy 配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%88%87%E9%9D%A2%E3%80%81%E5%AE%9A%E4%B9%89%E5%88%87%E7%82%B9%E5%92%8C%E9%80%9A%E7%9F%A5"><span class="nav-text">声明切面、定义切点和通知</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-Spring-MVC"><span class="nav-text">第六章 Spring MVC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81Spring-Application-Context"><span class="nav-text">1、Spring Application Context</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81Spring-MVC-%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-text">2、Spring MVC 的请求处理机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-MVC-%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-text">Spring MVC 的请求处理流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E5%AE%9A%E4%B9%89-Controller-%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="nav-text">3、定义 Controller 处理方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="nav-text">定义映射关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="nav-text">定义处理方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-text">定义类型转换</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-Formatter-%E5%AE%9E%E7%8E%B0%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-text">添加自定义的 Formatter 实现类型转换</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E6%A0%A1"><span class="nav-text">定义校</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Multipart-%E4%B8%8A%E4%BC%A0"><span class="nav-text">Multipart 上传</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E4%BE%8B"><span class="nav-text">代码实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-NewCoffeeRequest-%E7%B1%BB%E3%80%82"><span class="nav-text">创建一个 NewCoffeeRequest 类。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E7%9A%84-Controller-%E6%96%B9%E6%B3%95"><span class="nav-text">具体的 Controller 方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Postman-%E6%B5%8B%E8%AF%95"><span class="nav-text">Postman 测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81Spring-MVC-%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E6%9C%BA%E5%88%B6-%E2%80%93-%E8%A7%86%E5%9B%BE%E5%A4%84%E7%90%86"><span class="nav-text">4、Spring MVC 中的各种机制 – 视图处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80"><span class="nav-text">视图解析的实现基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DispatcherServlet-%E4%B8%AD%E7%9A%84%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E9%80%BB%E8%BE%91"><span class="nav-text">DispatcherServlet 中的视图解析逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ResponseBody-%E7%9A%84%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E9%80%BB%E8%BE%91"><span class="nav-text">@ResponseBody 的视图解析逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-text">重定向</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81Spring-MVC-%E4%B8%AD%E7%9A%84%E5%B8%B8%E7%94%A8%E8%A7%86%E5%9B%BE"><span class="nav-text">5、Spring MVC 中的常用视图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Boot-%E5%AF%B9-Jackson-%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-text">Spring Boot 对 Jackson 的支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Boot-%E4%B8%AD%E5%85%B3%E4%BA%8E-Jackson-%E7%9A%84%E5%AE%9E%E4%BE%8B"><span class="nav-text">Spring Boot 中关于 Jackson 的实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thymeleaf-%E9%A1%B5%E9%9D%A2%E8%B0%83%E7%94%A8%E7%9A%84%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90"><span class="nav-text">thymeleaf 页面调用的简单例子</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-create-order-form-html-%E9%A1%B5%E9%9D%A2"><span class="nav-text">创建一个简单的 create-order-form.html 页面</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-html-%E9%A1%B5%E9%9D%A2"><span class="nav-text">调用 html 页面</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#form-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%EF%BC%8C%E5%B9%B6%E4%B8%94%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-text">form 创建订单，并且重定向</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E3%80%81%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%B8%8E%E7%BC%93%E5%AD%98"><span class="nav-text">6、静态资源与缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Boot-%E4%B8%AD%E7%9A%84%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="nav-text">Spring Boot 中的静态资源配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Boot-%E4%B8%AD%E7%9A%84%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="nav-text">Spring Boot 中的缓存配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%E3%80%81Spring-MVC-%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-text">7、Spring MVC 中的异常处理机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-MVC-%E7%9A%84%E5%BC%82%E5%B8%B8%E8%A7%A3%E6%9E%90"><span class="nav-text">Spring MVC 的异常解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="nav-text">异常处理方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90"><span class="nav-text">一个异常处理的简单例子</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E8%B0%83%E7%94%A8%E4%BB%A3%E7%A0%81"><span class="nav-text">异常调用代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%B1%BB"><span class="nav-text">异常处理类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8%E3%80%81Spring-MVC-%E7%9A%84%E6%8B%A6%E6%88%AA%E5%99%A8%EF%A8%B8"><span class="nav-text">8、Spring MVC 的拦截器器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E2%BC%BC%E6%8E%A5%E2%BC%9D"><span class="nav-text">核⼼接⼝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%88%E5%AF%B9-ResponseBody-%E5%92%8C-ResponseEntity-%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-text">针对 @ResponseBody 和 ResponseEntity 的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E7%9A%84%E6%8E%A5%E2%BC%9D"><span class="nav-text">针对异步请求的接⼝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%A6%E6%88%AA%EF%A8%B8%E7%9A%84%E9%85%8D%E7%BD%AE%E2%BD%85%E5%BC%8F"><span class="nav-text">拦截器的配置⽅式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B"><span class="nav-text">实例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E8%AE%BF%E9%97%AE-Web-%E8%B5%84%E6%BA%90"><span class="nav-text">第七章 访问 Web 资源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-RestTemplate-%E8%AE%BF%E9%97%AE-Web-%E8%B5%84%E6%BA%90"><span class="nav-text">通过 RestTemplate 访问 Web 资源</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">常用方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0-URI"><span class="nav-text">构造 URI</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RestTemplate-%E7%9A%84%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95"><span class="nav-text">RestTemplate 的高阶用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%AE%9A%E5%88%B6-RestTemplate"><span class="nav-text">简单定制 RestTemplate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-WebClient-%E8%AE%BF%E9%97%AE-Web-%E8%B5%84%E6%BA%90"><span class="nav-text">通过 WebClient 访问 Web 资源</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%86%E8%A7%A3-WebClient"><span class="nav-text">了解 WebClient</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-Web-%E5%BC%80%E5%8F%91%E8%BF%9B%E9%98%B6"><span class="nav-text">第八章 Web 开发进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%A5%BD%E7%9A%84-RESTful-Web-Service"><span class="nav-text">设计好的 RESTful Web Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86-HTTP-%E2%BD%85%E6%96%B9%E6%B3%95"><span class="nav-text">认识 HTTP ⽅方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HATEOAS"><span class="nav-text">HATEOAS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Spring-Data-REST-%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E8%B6%85%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1"><span class="nav-text">使用 Spring Data REST 实现简单的超媒体服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86-HAL"><span class="nav-text">认识 HAL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HAL-%E6%A8%A1%E5%9E%8B"><span class="nav-text">HAL 模型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Data-REST"><span class="nav-text">Spring Data REST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%AE%BF%E9%97%AE-HATEOAS-%E6%9C%8D%E5%8A%A1"><span class="nav-text">如何访问 HATEOAS 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-Session-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">分布式环境中如何解决 Session 的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%EF%A7%A4"><span class="nav-text">实现原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-Redis-%E7%9A%84-HttpSession"><span class="nav-text">基于 Redis 的 HttpSession</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Boot-%E5%AF%B9-Spring-Session-%E7%9A%84%E2%BD%80%E6%8C%81"><span class="nav-text">Spring Boot 对 Spring Session 的⽀持</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-WebFlux-%E4%BB%A3%E6%9B%BF-Spring-MVC"><span class="nav-text">使用 WebFlux 代替 Spring MVC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86-WebFlux"><span class="nav-text">认识 WebFlux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WebMVC-v-s-WebFlux"><span class="nav-text">WebMVC v.s. WebFlux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WebFlux-%E4%B8%AD%E7%9A%84%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-text">WebFlux 中的编程模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84%E6%8E%A7%E5%88%B6%E5%99%A8%EF%A8%B8"><span class="nav-text">基于注解的控制器器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86-Spring-Boot"><span class="nav-text">第九章 重新认识 Spring Boot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">自动配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%BE%83%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">⾃动配置的实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F%E2%BE%83%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%9A%84%E5%88%A4%E6%96%AD%E7%BB%93%E6%9E%9C"><span class="nav-text">观察⾃动配置的判断结果</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ConditionEvaluationReportLoggingListener"><span class="nav-text">ConditionEvaluationReportLoggingListener</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E2%BC%BF%E5%AE%9E%E7%8E%B0%E2%BE%83%E2%BC%B0%E7%9A%84%E2%BE%83%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">动⼿实现⾃⼰的⾃动配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E6%B3%A8%E8%A7%A3%E2%BC%A4%E5%AE%B6%E5%BA%AD"><span class="nav-text">条件注解⼤家庭</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%BE%83%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%9A%84%E6%89%A7%E2%BE%8F%E9%A1%BA%E5%BA%8F"><span class="nav-text">⾃动配置的执⾏顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E2%BC%BF%E5%AE%9E%E7%8E%B0%E2%BE%83%E2%BC%B0%E7%9A%84%E2%BE%83%E5%8A%A8%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%A0%81"><span class="nav-text">动⼿实现⾃⼰的⾃动配置代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8%E4%BD%8E%E7%89%88%E6%9C%AC-Spring-%E4%B8%AD%E5%BF%AB%E9%80%9F%E5%AE%9E%E7%8E%B0%E7%B1%BB%E4%BC%BC%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-text">如何在低版本 Spring 中快速实现类似自动配置的功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E4%B8%8E%E9%97%AE%E9%A2%98"><span class="nav-text">需求与问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E2%BC%BC%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="nav-text">核⼼解决思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%89%A9%E5%B1%95%E7%82%B9"><span class="nav-text">Spring 的两个扩展点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%BC%80%E4%BA%9B%E5%B8%B8%E2%BD%A4%E6%93%8D%E4%BD%9C"><span class="nav-text">⼀些常⽤操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%8E%E7%89%88%E6%9C%AC-Spring-%E4%B8%AD%E5%BF%AB%E9%80%9F%E5%AE%9E%E7%8E%B0%E7%B1%BB%E4%BC%BC%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8A%9F%E8%83%BD%E4%BB%A3%E7%A0%81"><span class="nav-text">低版本 Spring 中快速实现类似自动配置功能代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%A6%BA%E8%A7%A3%E8%B5%B7%E6%AD%A5%E4%BE%9D%E8%B5%96%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">了解起步依赖及其实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-Maven-%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E2%BC%A9%E6%8A%80%E5%B7%A7"><span class="nav-text">关于 Maven 依赖管理的一些⼩技巧</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Boot-%E7%9A%84%E8%B5%B7%E6%AD%A5%E4%BE%9D%E8%B5%96"><span class="nav-text">Spring Boot 的起步依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E5%88%B6%E2%BE%83%E5%B7%B1%E7%9A%84%E8%B5%B7%E6%AD%A5%E4%BE%9D%E8%B5%96"><span class="nav-text">定制⾃己的起步依赖</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JQ"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">JQ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jiaoqiang2014" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiaoqiang2014" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2682745395@qq.com" title="E-Mail → mailto:2682745395@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class=""></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JQ</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">155k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">2:21</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
